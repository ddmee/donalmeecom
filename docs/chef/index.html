<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Chef - Donal Mee</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Chef | Donal Mee</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="Chef" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Notes on software and other things." /> <meta property="og:description" content="Notes on software and other things." /> <link rel="canonical" href="/chef/" /> <meta property="og:url" content="/chef/" /> <meta property="og:site_name" content="Donal Mee" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-08-20T08:00:00+01:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"/chef/","headline":"Chef","dateModified":"2020-08-20T08:00:00+01:00","datePublished":"2020-08-20T08:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"/chef/"},"description":"Notes on software and other things.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Donal Mee </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item active"><a href="/chef/" class="nav-list-link active">Chef</a></li><li class="nav-list-item"><a href="/fastai/" class="nav-list-link">Fast AI</a></li><li class="nav-list-item"><a href="/groovy/" class="nav-list-link">Groovy</a></li><li class="nav-list-item"><a href="/jekyll/" class="nav-list-link">Jekyll</a></li><li class="nav-list-item"><a href="/jenkins-and-groovy/" class="nav-list-link">Jenkins and Groovy</a></li><li class="nav-list-item"><a href="/powershell/" class="nav-list-link">Powershell</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Donal Mee" aria-label="Search Donal Mee" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <button class="btn js-toggle-dark-mode float-right">Dark mode</button> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="chef-kitchen"> <a href="#chef-kitchen" aria-labelledby="chef-kitchen" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chef Kitchen </h1> <ul id="markdown-toc"> <li><a href="#background" id="markdown-toc-background">Background</a></li> <li><a href="#what-is-chef" id="markdown-toc-what-is-chef">What is Chef?</a></li> <li><a href="#chef-infra" id="markdown-toc-chef-infra">Chef Infra</a></li> <li><a href="#starting-out-with-chef" id="markdown-toc-starting-out-with-chef">Starting out with Chef</a></li> <li><a href="#chef-run" id="markdown-toc-chef-run">Chef-Run</a></li> <li><a href="#policyfilesberkshelfknife" id="markdown-toc-policyfilesberkshelfknife">Policyfiles/Berkshelf/Knife</a> <ul> <li><a href="#policyfiles" id="markdown-toc-policyfiles">Policyfiles</a></li> </ul> </li> <li><a href="#attributes" id="markdown-toc-attributes">Attributes</a></li> <li><a href="#resource-guards" id="markdown-toc-resource-guards">Resource guards</a></li> <li><a href="#iteration" id="markdown-toc-iteration">Iteration</a></li> <li><a href="#winrm-second-hop" id="markdown-toc-winrm-second-hop">Winrm second hop</a></li> <li><a href="#how-to-customise-an-existing-resource" id="markdown-toc-how-to-customise-an-existing-resource">How to customise an existing resource?</a></li> <li><a href="#chocolately-package" id="markdown-toc-chocolately-package">Chocolately package</a></li> <li><a href="#use-paths-on-windows-without-pain" id="markdown-toc-use-paths-on-windows-without-pain">Use paths on windows without pain</a></li> <li><a href="#resources" id="markdown-toc-resources">Resources</a></li> </ul> <h2 id="background"> <a href="#background" aria-labelledby="background" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Background </h2> <p>Un-testable infrastructure is more hassle than it’s worth. Or at least, it’s difficult to deploy updates to the infrastructure, unless you’re already very familiar with it.</p> <p>Chef is a configuration-management toolkit written in Ruby. You can write ‘recipes’ (scripts) that will setup a machine for you. It’s part of the infrastructure-as-code movement.</p> <p>In dev-ops, if it deploys it works. That is the test. Correct? Well, I disagree. I think dev-ops requires solid automated tests, just like any other bit of your code-base. General cavets apply.</p> <p>Why introduce something like Chef if it becomes hard to change? While Chef offers the possibility of reducing your operation burden provisioning machines, untested Chef recipes increase your deployment friction. Thus, I believe, it’s important to consider how you can test recipes as you write ones for your environment.</p> <p>I.e. Chef might be great at helping you setup lots of machines, but how do you change your Chef setup without knowing you haven’t borked all your machine setups? Hmm.</p> <p>Thankfully, Chef provides some tools to help you do your job.</p> <h2 id="what-is-chef"> <a href="#what-is-chef" aria-labelledby="what-is-chef" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What is Chef? </h2> <p>You can find out about Chef at https://www.chef.io/</p> <p>You’ll find the company has really over-used the chef/kitchen/food/knife/supermarket analogy. Every bit of their product seems to be named after some part of the food preparation process. I guess they are analogising cooking your machines with provisioning your food. But I find the naming convention a bit irritating. However, it is distinctive.</p> <h2 id="chef-infra"> <a href="#chef-infra" aria-labelledby="chef-infra" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chef Infra </h2> <p>While Chef offers a few products, I believe the core of the project started around what is now called Chef Infra https://www.chef.io/products/chef-infra/ Visit the website for their sales pitch around how Chef makes your sex-life better.</p> <p>I believe, in essence, Chef runs an executable on each machine you want to configure via chef. This is called the Chef client. You pass the chef client a recipe or a bunch of recipes, written in a Ruby-based Chef-developed domain-specific-language. The important idea is the recipes are meant to be idempotent (idempotent means the recipe can be run again and again and the result will always be the same). This is meant to mean that you can bring your machine into ‘compliance’ with the recipe by just re-running it whenever. As chef recipes are extendable and you can write your own, obviously you can break the idempotency of the recipe. But that’s your responsibility.</p> <p>Apart from the idea of idempotency and providing a toolkit of recipes you can use, I don’t think there’s much else special about Chef. It is written in Ruby which will please some and annoy others. There are competitors, for example like Ansible written in Python. And for your environment, you may just be best considering the language your team is most comfortable with. There’s not a whole lot of point introducing Chef if your working environment has a strong preference for Python. Opt for ansible then. Or, etc, whatever configuration toolkit uses a language your team members are most familiar with.</p> <p>Infra documentation begins at https://docs.chef.io/chef_overview/</p> <h2 id="starting-out-with-chef"> <a href="#starting-out-with-chef" aria-labelledby="starting-out-with-chef" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Starting out with Chef </h2> <p>Chef have quite polished tutorials at https://learn.chef.io. Though, they also leave a lot of questions unanswered. They aren’t particularly comprehensive. But give a reasonable introduction.</p> <p>You want to check that you have chef installed on your development machine. Run</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>chef <span class="nt">--version</span>
ChefDK version: 4.7.73
Chef Infra Client version: 15.7.32
Chef InSpec version: 4.18.51
Test Kitchen version: 2.3.4
Foodcritic version: 16.2.0
Cookstyle version: 5.20.0</code></pre></figure> <p>Note, Chef is fundamentally about provisioning machines. So, unless you want to alter your development machine, you need some way to spawn new machines. Chef typically uses this Test Kitchen to run tests on recipes.</p> <p>Check Test Kitchen is available, run</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>kitchen <span class="nt">--version</span>
Test Kitchen version 2.3.4</code></pre></figure> <p>Test kitchen can be extended to start any sort of machine, but most of the tutorials show you have to use VirtualBox and Vagrant to start machines.</p> <p>Check Vagrant is available, run</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>vagrant <span class="nt">--version</span>
vagrant 2.2.9</code></pre></figure> <p>What is Vagrant? It’s a tool for managing (starting/stopping/deleting) virtual-machines, using providers like VMWare, AWS, Docker, VirtualBox etc.</p> <p>Create a directory called ‘learn-chef-infra’ then generate the minimum required files using a generate command. Run</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span><span class="nb">mkdir </span>chef-learn-infra
<span class="o">&gt;</span><span class="nb">cd </span>chef-learn-infra
<span class="o">&gt;</span>chef generate cookbook learn_chef</code></pre></figure> <p>Generating cookbook learn_chef</p> <ul> <li>Ensuring correct cookbook content</li> <li>Committing cookbook files to git</li> </ul> <p>Your cookbook is ready. Type <code class="language-plaintext highlighter-rouge">cd learn_chef</code> to enter it.</p> <p>There are several commands you can run to get started locally developing and testing your cookbook.</p> <p>Type <code class="language-plaintext highlighter-rouge">delivery local --help</code> to see a full list of local testing commands.</p> <p>Why not start by writing an InSpec test? Tests for the default recipe are stored at: <code class="language-plaintext highlighter-rouge">test/integration/default/default_test.rb</code></p> <p>If you’d prefer to dive right in, the default recipe can be found at: <code class="language-plaintext highlighter-rouge">recipes/default.rb</code></p> <p>You’ll see that this has created a bunch of files in the directory.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\dev\chef\learn-chef-infra\learn_chef
C:\dev\chef\learn-chef-infra\learn_chef\.delivery
C:\dev\chef\learn-chef-infra\learn_chef\recipes
C:\dev\chef\learn-chef-infra\learn_chef\spec
C:\dev\chef\learn-chef-infra\learn_chef\test
C:\dev\chef\learn-chef-infra\learn_chef\.gitignore
C:\dev\chef\learn-chef-infra\learn_chef\CHANGELOG.md
C:\dev\chef\learn-chef-infra\learn_chef\chefignore
C:\dev\chef\learn-chef-infra\learn_chef\kitchen.yml
C:\dev\chef\learn-chef-infra\learn_chef\LICENSE
C:\dev\chef\learn-chef-infra\learn_chef\metadata.rb
C:\dev\chef\learn-chef-infra\learn_chef\Policyfile.rb
C:\dev\chef\learn-chef-infra\learn_chef\README.md
C:\dev\chef\learn-chef-infra\learn_chef\.delivery\project.toml
C:\dev\chef\learn-chef-infra\learn_chef\recipes\default.rb
C:\dev\chef\learn-chef-infra\learn_chef\spec\unit
C:\dev\chef\learn-chef-infra\learn_chef\spec\spec_helper.rb
C:\dev\chef\learn-chef-infra\learn_chef\spec\unit\recipes
C:\dev\chef\learn-chef-infra\learn_chef\spec\unit\recipes\default_spec.rb
C:\dev\chef\learn-chef-infra\learn_chef\test\integration
C:\dev\chef\learn-chef-infra\learn_chef\test\integration\default
C:\dev\chef\learn-chef-infra\learn_chef\test\integration\default\default_test.rb
</code></pre></div></div> <p>• The things inside the <code class="language-plaintext highlighter-rouge">\.directory</code> can be ignored. • <code class="language-plaintext highlighter-rouge">\spec</code> directory basically contain unit-tests for your ruby recipes • <code class="language-plaintext highlighter-rouge">\recipes</code> are where you use Chef’s Ruby DSL to describe how you want your machines configured • <code class="language-plaintext highlighter-rouge">\test</code> provide integration tests that Test Kitchen can run. This will allow you to check the recipes actually work as expected on specific machines. • The rest of the files are basically configurations files</p> <p>You’ll probably notice the new directory generated is also a git repository.</p> <p>If you have vagrant installed, you should be able to run kitchen list. (Note, kitchen list is specific to the directory you are in. It reads the configuration files, primarily <code class="language-plaintext highlighter-rouge">kitchen.yml</code>. So you must be in the correct directory to run it.)</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span><span class="nb">cd </span>learn_chef
<span class="o">&gt;</span>kitchen list
Instance             Driver   Provisioner  Verifier  Transport  Last Action    Last Error
default-ubuntu-1804  Vagrant  ChefZero     Inspec    Ssh        &lt;Not Created&gt;  &lt;None&gt;
default-centos-7     Vagrant  ChefZero     Inspec    Ssh        &lt;Not Created&gt;  &lt;None&gt;</code></pre></figure> <p>This lists the (virtual) machines that the <code class="language-plaintext highlighter-rouge">kitchen.yml</code> is configured to run the integration tests against. Note, the default driver is Vagrant. You can create your own drivers if you’re environment has specific ways to create virtual-machines or you can use the provided drivers for things like Google, AWS, etc.</p> <p>The listed machines haven’t actually been created yet. You can get Kitchen to create the virtual machines, will itself will just ask Vagrant to do this, and then will wait for an SSH server to start on the new VMs. (As the transport is also set to SSH. Again, this can be changed if you need.) Once the SSH is started, it will connect to the machine and then will issue commands to install the chef client executable on the VM. It will transfer the recipe across to the machine and then will run the recipe of the machine. You do all this in one go by running <code class="language-plaintext highlighter-rouge">kitchen converge</code>. Pretty neat.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>kitchen converge
… &lt;runs off&gt;</code></pre></figure> <p>Then you can run <code class="language-plaintext highlighter-rouge">kitchen list</code> again and it’ll indicate the last action on the machines worked out.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>kitchen list
Instance             Driver   Provisioner  Verifier  Transport  Last Action  Last Error
default-ubuntu-1804  Vagrant  ChefZero     Inspec    Ssh        Converged    &lt;None&gt;
default-centos-7     Vagrant  ChefZero     Inspec    Ssh        Converged    &lt;None&gt;</code></pre></figure> <p>You can login to the machine that Kitchen has created using ‘kitchen login’. Writing a recipe</p> <p>You can write recipes in either yaml or ruby. I’ll use Ruby given I like the flexibility of a programming language.</p> <p>You can write the recipe inside the default.rb (i.e. at <code class="language-plaintext highlighter-rouge">learn-chef-infra/learn_chef/recipes/default.rb</code>) or you can create a new ruby file and import it into default.rb.</p> <p>Create a file at <code class="language-plaintext highlighter-rouge">learn-chef-infra/learn_chef/recipes/learn-chef.rb</code></p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">include_recipe</span> <span class="s2">"learn_chef::learn-chef"</span></code></pre></figure> <p>For a ruby recipe, you use a <code class="language-plaintext highlighter-rouge">do..end</code> ruby block (basically a closure)</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">file</span> <span class="s2">"/etc/mota"</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">"its better in ruby though"</span>
<span class="k">end</span></code></pre></figure> <p>Or you can start a web server like so package ‘apache2’</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">file</span> <span class="s2">"/var/www/html/index.html"</span> <span class="k">do</span>
    <span class="n">content</span> <span class="s2">"hello moto"</span>
<span class="k">end</span>

<span class="n">service</span> <span class="s1">'apache2'</span> <span class="k">do</span>
    <span class="n">action</span> <span class="p">[</span><span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span><span class="p">]</span>
<span class="k">end</span></code></pre></figure> <p>I think it’s probably worth noting that recipes are executed from top to bottom. I believe.</p> <p>You can get rid of the stuff created by kitchen with <code class="language-plaintext highlighter-rouge">kitchen destroy</code>. Otherwise, kitchen leaves the machines around between converges, which does help to speed up the tests.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>kitchen destroy
<span class="nt">-----</span><span class="o">&gt;</span> Starting Test Kitchen <span class="o">(</span>v2.3.4<span class="o">)</span>
<span class="nt">-----</span><span class="o">&gt;</span> Destroying &lt;default-ubuntu-1804&gt;...
       <span class="o">==&gt;</span> default: Forcing shutdown of VM...
       <span class="o">==&gt;</span> default: Destroying VM and associated drives...
       Vagrant instance &lt;default-ubuntu-1804&gt; destroyed.
       Finished destroying &lt;default-ubuntu-1804&gt; <span class="o">(</span>0m8.63s<span class="o">)</span><span class="nb">.</span>
<span class="nt">-----</span><span class="o">&gt;</span> Test Kitchen is finished. <span class="o">(</span>0m10.80s<span class="o">)</span></code></pre></figure> <h2 id="chef-run"> <a href="#chef-run" aria-labelledby="chef-run" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chef-Run </h2> <p>Chef-run is a tool to execute ad-hoc tasks on one or more target nodes using Chef. (Documentation here https://www.chef.sh/docs/reference/chef-run/) It is installed if you install Chef Workstation (which is basically a sort of development environment, documentation here https://www.chef.sh/docs/chef-workstation/getting-started/).</p> <p>You can use it to run recipes or resources on machines, in an ad-hoc fashion.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>chef-run web1 file hello.txt <span class="nv">content</span><span class="o">=</span>’hello world’
<span class="o">[</span>✔] Packaging cookbook... <span class="k">done</span><span class="o">!</span>
<span class="o">[</span>✔] Generating <span class="nb">local </span>policyfile... exporting... <span class="k">done</span><span class="o">!</span>
<span class="o">[</span>✔] Applying file[hello.txt] from resource to target.
└── <span class="o">[</span>✔] <span class="o">[</span>web1] Successfully converged file[hello.txt].</code></pre></figure> <p>This will connect to a machine called ‘web1’ (note, this would need to be configured as an alias), and it will create the file on the machine. Likewise, we could then check the contents of the file, and then run another ad-hoc command to delete the file.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>ssh web1 <span class="nb">cat</span> /hello.txt
hello world
<span class="o">&gt;</span>chef-run web1 file hello.txt <span class="nv">action</span><span class="o">=</span>delete
<span class="o">[</span>✔] Packaging cookbook... <span class="k">done</span><span class="o">!</span>
<span class="o">[</span>✔] Generating <span class="nb">local </span>policyfile... exporting... <span class="k">done</span><span class="o">!</span>
<span class="o">[</span>✔] Applying file[hello.txt] from resource to target.
└── <span class="o">[</span>✔] <span class="o">[</span>web1] Successfully converged file[hello.txt].</code></pre></figure> <p>Rather than just running ad-hoc resources invocations, we can also run recipes or cookbooks.</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>chef-run web1 recipe.rb
<span class="o">&gt;</span>chef-run web1 cookbook1</code></pre></figure> <p>Note, that a recipe is a standalone file. Whereas, a cookbook is a directory with a metadata.rb and a recipes directory.</p> <p>metadata.rb contains information like what other cookbooks this cookbook depends upon, plus states a version number of the cookbook. A metadata file looks something like this:</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">name</span> <span class="s1">'base'</span>
<span class="n">maintainer</span> <span class="s1">'The Authors'</span>
<span class="n">maintainer_email</span> <span class="s1">'you@example.com'</span>
<span class="n">license</span> <span class="s1">'All Rights Reserved'</span>
<span class="n">description</span> <span class="s1">'Installs/Configures base'</span>
<span class="n">long_description</span> <span class="s1">'Installs/Configures base'</span>
<span class="n">version</span> <span class="s1">'0.1.0'</span>
<span class="n">chef_version</span> <span class="s1">'&gt;= 13.0'</span>

<span class="n">depends</span> <span class="s1">'os-hardening'</span></code></pre></figure> <p>Note, while a metadata file might describe what the cookbook depends upon, it doesn’t tell chef how to find those dependencies. That is control by a berksfile or a policyfile. For example, the hardening cookbook can be found at https://supermarket.chef.io/cookbooks/os-hardening. See the section on PolicyFiles for more information.</p> <p>Recipes directory contains other recipes, the default being ‘default.rb’</p> <p>A cookbook can also contain a ‘templates’ directory, that contains ‘.erb’ files (Ruby template files). There is a template resource (documentation here https://docs.chef.io/templates/ ) can use the template to create files on the clients.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">template</span> <span class="err">‘</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="nf">html</span><span class="err">’</span> <span class="k">do</span>
  <span class="n">source</span> <span class="err">‘</span><span class="n">index</span><span class="p">.</span><span class="nf">html</span><span class="p">.</span><span class="nf">erb</span><span class="err">’</span>
<span class="k">end</span></code></pre></figure> <p>This would create the index.html on the client provided the templates directory contains an ‘index.html.erb’ file like so</p> <figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>This is chef client node <span class="nt">&lt;</span><span class="err">%=</span><span class="na">node</span><span class="err">[‘</span><span class="na">hostname</span><span class="err">’]%</span><span class="nt">&gt;</span> <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre></figure> <p>A cookbook can also contain an attributes directory. Attributes can be generated with chef generate attribute <code class="language-plaintext highlighter-rouge">&lt;cookbook_path&gt; &lt;name&gt;</code></p> <p>A cookbook can also contain a files directory.</p> <h2 id="policyfilesberkshelfknife"> <a href="#policyfilesberkshelfknife" aria-labelledby="policyfilesberkshelfknife" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Policyfiles/Berkshelf/Knife </h2> <p>The older version of a PolicyFile was the Berks file. Basically, they are about specifying where dependencies ought to be fetched from. I believe knife is basically a way of fetching/installing dependencies. For example, for https://supermarket.chef.io/cookbooks/os-hardening it lists as ways to install it:</p> <ul> <li>Berkshelf <code class="language-plaintext highlighter-rouge">cookbook ‘os-hardening’, ‘~&gt; 4.0.0’</code></li> <li>Policyfile <code class="language-plaintext highlighter-rouge">Cookbook ‘os-hardening’, ‘~&gt; 4.0.0’, :supermarket</code></li> <li>Knife <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>knife supermarket install os-hardening
knife supermarket download os-hardening
</code></pre></div> </div> </li> </ul> <h3 id="policyfiles"> <a href="#policyfiles" aria-labelledby="policyfiles" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Policyfiles </h3> <p>A policyfile is “Policyfile.rb” that sits alongside the metadata.rb of a recipe.</p> <p>“A Policyfile declares the name, run_list, sources, and attributes for a node or group of nodes. Policyfiles also handle all dependency resolution for your cookbooks.”…“Policyfiles give you the confidence that the version of cookbook you specify will always be the one deployed.”…“Policyfiles give you the confidence that the version of cookbook you specify will always be the one deployed.”</p> <p>You can generate a policyfile when generating the cookbook by using -P switch</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef generate cookbook &lt;name&gt; -P
</code></pre></div></div> <p>Or you can generate a policyfile with a separate invocation</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chef generate policyfile &lt;name&gt;
</code></pre></div></div> <p>A policyfile looks like this</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Policyfile.rb - Describe how you want Chef Infra Client to build
</span>
<span class="c1"># your system.
</span>
<span class="c1"># For more information on the Policyfile feature, visit
</span>
<span class="c1"># https://docs.chef.io/policyfile.html
</span>

<span class="c1"># A name that describes what the system you're building with Chef
</span>
<span class="c1"># does. Used to reference this policyfile on Chef server and must be
</span>
<span class="c1"># thus unique.
</span>
<span class="nb">name</span> <span class="s1">'base'</span>

<span class="c1"># Where to find external cookbooks if they are not specifically
</span>
<span class="c1"># declared in the cookbook section below
</span>
<span class="n">default_source</span> <span class="ss">:supermarket</span>

<span class="c1"># run_list: chef-client will run these recipes in the order 
</span>
<span class="c1"># specified. 
</span>
<span class="n">run_list</span> <span class="s1">'base::default'</span>

<span class="c1"># Specify a custom source for a single cookbook. Provide local 
</span>
<span class="c1"># cookbooks that if are specified as a dependency will  be found
</span>
<span class="c1"># before chef looks in supermarket.
</span>
<span class="n">cookbook</span> <span class="s1">'base'</span><span class="p">,</span> <span class="ss">path: </span><span class="s1">'.'</span>
<span class="n">cookbook</span> <span class="s1">'hardening'</span><span class="p">,</span> <span class="ss">path: </span><span class="s1">'../hardening'</span></code></pre></figure> <p>Having defined the policyfile, we need to resolve the listed dependencies to produce a Policyfile.lock.json that ensures reproduction.</p> <p>We run</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>chef <span class="nb">install </span>cookbooks/base/Policyfile.rb
Building policy base
Expanded run list: recipe[base::default]
Caching Cookbooks...
Installing base      <span class="o">&gt;=</span> 0.0.0 from path
Installing hardening <span class="o">&gt;=</span> 0.0.0 from path
Using      os-hardening            4.0.0
Using      windows-hardening       0.9.1
Using      windows-security-policy 0.3.9

Lockfile written to C:/dev/chef/lcr-policyfiles-getstarted/cookbooks/base/Policyfile.lock.json
Policy revision <span class="nb">id</span>: ca474c6e5bca2eda927549bd33efe1f9ccc7e74e26c2922b0a4d57805555cef5</code></pre></figure> <p>Then if we re-run the same command, it just uses the lockfile direct</p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">&gt;</span>chef <span class="nb">install </span>cookbooks/base/Policyfile.rb
Installing cookbooks from lock
Installing base                    0.1.0
Installing hardening               0.1.0
Using      os-hardening            4.0.0
Using      windows-hardening       0.9.1
Using      windows-security-policy 0.3.9</code></pre></figure> <p>Running chef install reads the Policyfile.rb and creates a Policyfile.lock.json file. This Policyfile.lock.json file is the actual policy used by Chef Client and contains unique references to the cookbooks in the run_list. The Policyfile.rb file is really only used as a human readable/editable file used to create the related Policyfile.lock.json file.</p> <p>The Policyfile.lock.json file consolidates all dependencies in the run_list. This file gets downloaded to your node and read by chef-client. The chef-client will then download the precise versions of all dependencies and run them locally.</p> <p>The Policyfile.lock.json specifies not only the cookbooks required, but also the exact SHA fingerprint of all of the associated files and a checksum of the cookbook contents. If the contents change in any way, then the checksum will change and chef-client not run the policy.</p> <p>If you were to use this same lock file on another workstation, then you can be certain it will use the same version of the cookbooks. If it cannot find these versions, then chef-client will return an error.</p> <p>If you have made changes to the policyfile, you can update it with</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;chef update Policyfile.rb
</code></pre></div></div> <p> </p> <h2 id="attributes"> <a href="#attributes" aria-labelledby="attributes" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Attributes </h2> <p>The attributes folders basically seems to be a way of storing variables that recipes can access. When OHAI runs, it sets the attributes of a node (a node is an object that represents the machine being configured by chef). So you can get attributes that inform you about what platform or machine the recipe is being run on, so that’s pretty good for dynamic data. But you can also define your own attributes, which seem to be more or less arguments to the recipes you’ve created, I think.</p> <p>This seems to explain it more https://docs.aws.amazon.com/opsworks/latest/userguide/cookbooks-101-basics-attributes.html</p> <h2 id="resource-guards"> <a href="#resource-guards" aria-labelledby="resource-guards" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resource guards </h2> <p>Quite often you only want to run a resource if something is missing or whatever. This is what is a resource ‘guard’ is for, and you can use them on any resource. There seem to be two ‘only_if’ and ‘not_if’. Only_if means the resource will run if the condition is true. Not_if prevents the resource is not run if true.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">powershell_script</span> <span class="s2">"Connect to </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
        <span class="n">code</span> <span class="s2">"net use </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2"> /USER:&lt;username&gt; /PERSISTENT:YES &lt;pass&gt;"</span>
        <span class="c1"># Only run if the directory isn't already available
</span>
        <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">Dir</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure> <h2 id="iteration"> <a href="#iteration" aria-labelledby="iteration" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Iteration </h2> <p>Maybe you want to do the same resource for multiple things? Luckily, you can just run an iteration loop. I suppose this really shows that the DSL is just ruby. AWS documentation has some nice examples on this https://docs.aws.amazon.com/opsworks/latest/userguide/cookbooks-101-basics-ruby.html#cookbooks-101-basics-ruby-iteration</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">[</span> <span class="s2">"/srv/www/config"</span><span class="p">,</span> <span class="s2">"/srv/www/shared"</span> <span class="p">].</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
  <span class="n">directory</span> <span class="n">path</span> <span class="k">do</span>
    <span class="n">mode</span> <span class="mo">0755</span>
    <span class="n">owner</span> <span class="s1">'root'</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>And you can iterate over whatever iterable ruby allows, including hash tables</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span> <span class="s2">"/srv/www/config"</span> <span class="o">=&gt;</span> <span class="mo">0644</span><span class="p">,</span> <span class="s2">"/srv/www/shared"</span> <span class="o">=&gt;</span> <span class="mo">0755</span> <span class="p">}.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="p">,</span> <span class="n">mode_value</span><span class="o">|</span>
  <span class="n">directory</span> <span class="n">path</span> <span class="k">do</span>
    <span class="n">mode</span> <span class="n">mode_value</span>
    <span class="n">owner</span> <span class="s1">'root'</span>
    <span class="n">group</span> <span class="s1">'root'</span>
    <span class="n">recursive</span> <span class="kp">true</span>
    <span class="n">action</span> <span class="ss">:create</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <h2 id="winrm-second-hop"> <a href="#winrm-second-hop" aria-labelledby="winrm-second-hop" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Winrm second hop </h2> <p>There is an authentication issue with win-rm accessing remote fileshares called the second hop problem. I was searching for a while how to fix it, and I struggled. Eventually I found there’s a parameter called ‘elevated’ that if you set to true for the winrm transport, it’ll run as a service and this seems to get around the second hop issues. I.e. like this in the kitchen.yml</p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">---</span><span class="err">
</span>
<span class="na">driver</span><span class="pi">:</span><span class="err">
</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">custom-vms</span><span class="err">
</span>
  <span class="na">vm_user</span><span class="pi">:</span> <span class="s">&lt;user&gt;</span><span class="err">
</span>
  <span class="na">vm_token</span><span class="pi">:</span> <span class="s">&lt;token&gt;</span><span class="err">
</span>

<span class="na">platforms</span><span class="pi">:</span><span class="err">
</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test-win10-20h1</span><span class="err">
</span>
    <span class="na">driver</span><span class="pi">:</span><span class="err">
</span>
      <span class="na">vmtemplate</span><span class="pi">:</span> <span class="s">test-win10-20h1</span><span class="err">
</span>
    <span class="na">transport</span><span class="pi">:</span><span class="err">
</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">winrm</span><span class="err">
</span>
      <span class="na">elevated</span><span class="pi">:</span> <span class="no">true</span><span class="err">
</span>
      <span class="na">username</span><span class="pi">:</span> <span class="s">&lt;user&gt;</span><span class="err">
</span>
      <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;pass&gt;</span></code></pre></figure> <p>I had found this problem doesn’t exist with OpenSSH, so you can install it but you need to configure the private key etc.</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">pub_key</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
<span class="sh">
&lt;PUBLIC SSH KEY HERE&gt;
</span><span class="no">EOH
</span>

<span class="n">ssh_script</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
<span class="sh">
choco install OpenSSh -y --params /SSHServerFeature
Set-Service -Name sshd -StartupType 'Automatic'
New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22
New-ItemProperty -Path "HKLM:</span><span class="se">\\</span><span class="sh">SOFTWARE</span><span class="se">\\</span><span class="sh">OpenSSH" -Name DefaultShell -Value "C:</span><span class="se">\\</span><span class="sh">Windows</span><span class="se">\\</span><span class="sh">System32</span><span class="se">\\</span><span class="sh">WindowsPowerShell</span><span class="se">\\</span><span class="sh">v1.0</span><span class="se">\\</span><span class="sh">powershell.exe" -PropertyType String -Force
</span><span class="no">EOH
</span>

<span class="n">powershell_script</span> <span class="s1">'Setup Open-Ssh service'</span> <span class="k">do</span>
    <span class="n">code</span> <span class="n">ssh_script</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s1">'C:\ProgramData\ssh\ssh_host_rsa_key.pub'</span> <span class="k">do</span>
    <span class="n">content</span> <span class="n">pub_key</span>
<span class="k">end</span>

<span class="n">file</span> <span class="s1">'C:\ProgramData\ssh\ssh_host_rsa_key'</span> <span class="k">do</span>
    <span class="n">action</span> <span class="ss">:delete</span>
<span class="k">end</span></code></pre></figure> <h2 id="how-to-customise-an-existing-resource"> <a href="#how-to-customise-an-existing-resource" aria-labelledby="how-to-customise-an-existing-resource" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to customise an existing resource? </h2> <p>Let’s say I want to use in the in-built chef recipe, chocolatey_package, but I need to customise it so that after it runs, it also runs ‘refreshenv.bat’. I had a problem that even though I’ve installed a resource, the shell sessions path isn’t updated to know where Java is.</p> <h2 id="chocolately-package"> <a href="#chocolately-package" aria-labelledby="chocolately-package" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Chocolately package </h2> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Install Java from a local chocolately mirror
</span>
<span class="n">chocolatey_package</span> <span class="s1">'OpenJDKJre'</span> <span class="k">do</span>
   <span class="n">package_name</span> <span class="s1">'OpenJDKjre'</span>
   <span class="n">source</span> <span class="s1">'\\\\test.corpb.local\\ChocolateyMirror'</span>
   <span class="n">version</span> <span class="s2">"11.0.7.10"</span>
<span class="k">end</span>

<span class="c1"># I end up doing a hack, otherwise java executable can’t be found
</span>
<span class="c1"># Seems there may be an issue getting new envvars.
</span>
<span class="no">Powershell_script</span> <span class="err">‘</span><span class="n">run</span> <span class="n">java</span><span class="err">’</span> <span class="k">do</span>
   <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
<span class="sh">
import-module "C:</span><span class="se">\\</span><span class="sh">ProgramData</span><span class="se">\\</span><span class="sh">chocolatey</span><span class="se">\\</span><span class="sh">helpers</span><span class="se">\\</span><span class="sh">chocolateyProfile.psm1"
Update-SessionEnvironment
java -jar 'C:</span><span class="se">\\</span><span class="sh">jenkins-swarm</span><span class="se">\\</span><span class="sh">swarm-client-3.9.jar'
</span><span class="no">EOH
</span>
<span class="k">end</span></code></pre></figure> <h2 id="use-paths-on-windows-without-pain"> <a href="#use-paths-on-windows-without-pain" aria-labelledby="use-paths-on-windows-without-pain" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Use paths on windows without pain </h2> <p>Paths of windows in chef recipes normally look like this ‘C:\some\path\hurts’</p> <p>You can try various ruby solutions to allow yourself to avoid the double backslash. I never succeeded getting that to work.</p> <p>This suggestion came from https://www.slideshare.net/opscode/chef-conf-windowsdougireton</p> <figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># include Windows::Helper from Opscode Windows Cookbook
</span>
<span class="o">::</span><span class="no">Chef</span><span class="o">::</span><span class="no">Recipe</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="no">Windows</span><span class="o">::</span><span class="no">Helper</span><span class="p">)</span>
<span class="c1"># now you can call helper methods like win_friendly_path
</span>
<span class="n">my_file</span> <span class="o">=</span> <span class="n">win_friendly_path</span><span class="p">(</span><span class="s1">'c:/no/insane/backslashes.tmp'</span><span class="p">)</span>

<span class="n">execute</span> <span class="s1">'My file'</span> <span class="k">do</span>
  <span class="n">command</span> <span class="n">my_file</span>
<span class="k">end</span></code></pre></figure> <h2 id="resources"> <a href="#resources" aria-labelledby="resources" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resources </h2> <ul> <li>https://zwischenzugs.com/2017/11/25/ten-things-i-wish-id-known-about-chef/</li> <li>AWS actually has some really good documentation to help people become acquainted with chef. https://docs.aws.amazon.com/opsworks/latest/userguide/cookbooks-101-basics-ruby.html</li> </ul> </div> </div> <div class="search-overlay"></div> </div> <script> const toggleDarkMode = document.querySelector('.js-toggle-dark-mode'); jtd.addEvent(toggleDarkMode, 'click', function(){ if (jtd.getTheme() === 'dark') { jtd.setTheme('light'); toggleDarkMode.textContent = 'Dark mode'; } else { jtd.setTheme('dark'); toggleDarkMode.textContent = 'Light mode'; } }); </script> </body> </html>
