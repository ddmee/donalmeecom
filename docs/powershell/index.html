<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Powershell - Donal Mee</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Powershell | Donal Mee</title> <meta name="generator" content="Jekyll v4.1.1" /> <meta property="og:title" content="Powershell" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Notes on software and other things." /> <meta property="og:description" content="Notes on software and other things." /> <link rel="canonical" href="/powershell/" /> <meta property="og:url" content="/powershell/" /> <meta property="og:site_name" content="Donal Mee" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-08-19T16:37:49+01:00" /> <script type="application/ld+json"> {"@type":"BlogPosting","url":"/powershell/","headline":"Powershell","dateModified":"2020-08-19T16:37:49+01:00","datePublished":"2020-08-19T16:37:49+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"/powershell/"},"description":"Notes on software and other things.","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Donal Mee </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/about/" class="nav-list-link">About</a></li><li class="nav-list-item"><a href="/chef/" class="nav-list-link">Chef</a></li><li class="nav-list-item"><a href="/groovy/" class="nav-list-link">Groovy</a></li><li class="nav-list-item"><a href="/jekyll/" class="nav-list-link">Jekyll</a></li><li class="nav-list-item"><a href="/jenkins-and-groovy/" class="nav-list-link">Jenkins and Groovy</a></li><li class="nav-list-item active"><a href="/powershell/" class="nav-list-link active">Powershell</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Donal Mee" aria-label="Search Donal Mee" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <button class="btn js-toggle-dark-mode float-right">Dark mode</button> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="powershell"> <a href="#powershell" aria-labelledby="powershell" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Powershell </h1> <ul id="markdown-toc"> <li><a href="#get-the-type-of-something" id="markdown-toc-get-the-type-of-something">Get the type of something</a></li> <li><a href="#type-literals" id="markdown-toc-type-literals">Type literals</a></li> <li><a href="#arrays" id="markdown-toc-arrays">Arrays</a></li> <li><a href="#hashtables-dictionaries" id="markdown-toc-hashtables-dictionaries">Hashtables (dictionaries)</a></li> <li><a href="#create-your-own-new-object" id="markdown-toc-create-your-own-new-object">Create your own new object</a> <ul> <li><a href="#copy-an-object" id="markdown-toc-copy-an-object">Copy an object</a></li> <li><a href="#compare-object" id="markdown-toc-compare-object">Compare Object</a></li> </ul> </li> <li><a href="#enumerations" id="markdown-toc-enumerations">Enumerations</a></li> <li><a href="#parameters" id="markdown-toc-parameters">Parameters</a></li> <li><a href="#splatting" id="markdown-toc-splatting">Splatting</a></li> <li><a href="#copying-files-and-folders" id="markdown-toc-copying-files-and-folders">Copying files and folders</a></li> <li><a href="#find-files-in-a-directory" id="markdown-toc-find-files-in-a-directory">Find files in a directory</a></li> <li><a href="#get-event-logs-from-the-system" id="markdown-toc-get-event-logs-from-the-system">Get event logs from the system!</a></li> <li><a href="#grep-for-lines-in-a-text-file" id="markdown-toc-grep-for-lines-in-a-text-file">Grep for lines in a text file</a></li> <li><a href="#get-the-date" id="markdown-toc-get-the-date">Get the date!</a></li> <li><a href="#mark-as-script-as-admin-only" id="markdown-toc-mark-as-script-as-admin-only">Mark as script as admin only</a></li> <li><a href="#create-an-background-job" id="markdown-toc-create-an-background-job">Create an background job</a></li> <li><a href="#debugging" id="markdown-toc-debugging">Debugging</a> <ul> <li><a href="#tracingcapturing-session-output-with-a-transcript" id="markdown-toc-tracingcapturing-session-output-with-a-transcript">Tracing/Capturing session output with a transcript</a></li> </ul> </li> <li><a href="#error-behaviour" id="markdown-toc-error-behaviour">Error behaviour</a> <ul> <li><a href="#terminating-errors" id="markdown-toc-terminating-errors">Terminating errors</a></li> <li><a href="#exception-does-not-print-line-error-occurred" id="markdown-toc-exception-does-not-print-line-error-occurred">Exception does not print line error occurred?</a></li> </ul> </li> <li><a href="#catching-an-exception" id="markdown-toc-catching-an-exception">Catching an exception</a></li> <li><a href="#throwing-exceptions" id="markdown-toc-throwing-exceptions">Throwing exceptions</a></li> <li><a href="#remote-commands" id="markdown-toc-remote-commands">Remote commands</a></li> <li><a href="#create-a-transcript" id="markdown-toc-create-a-transcript">Create a transcript</a></li> <li><a href="#convert-something-to-a-bool" id="markdown-toc-convert-something-to-a-bool">Convert something to a bool</a></li> <li><a href="#delayed-execution-lambdaanonomous-functions" id="markdown-toc-delayed-execution-lambdaanonomous-functions">Delayed execution, lambda/anonomous functions</a></li> <li><a href="#function-decorators" id="markdown-toc-function-decorators">Function decorators</a></li> <li><a href="#reimporting-a-module" id="markdown-toc-reimporting-a-module">Reimporting a module</a></li> <li><a href="#find-current-file-locations" id="markdown-toc-find-current-file-locations">Find current file location’s</a></li> <li><a href="#scopes" id="markdown-toc-scopes">Scopes</a></li> <li><a href="#try-to-return-last-exit-code-only-from-a-function" id="markdown-toc-try-to-return-last-exit-code-only-from-a-function">Try to return last-exit code only from a function</a></li> <li><a href="#returning-things-from-functions" id="markdown-toc-returning-things-from-functions">Returning things from functions</a></li> <li><a href="#the-ast" id="markdown-toc-the-ast">The AST</a></li> <li><a href="#posh-things-that-suck" id="markdown-toc-posh-things-that-suck">POSH things that suck</a> <ul> <li><a href="#namespaces" id="markdown-toc-namespaces">Namespaces</a></li> <li><a href="#out-string-tricky-strings" id="markdown-toc-out-string-tricky-strings">Out-string, tricky strings!</a></li> <li><a href="#conver-between-user-names-and-ssids" id="markdown-toc-conver-between-user-names-and-ssids">Conver between user names and ssids</a></li> <li><a href="#certicates" id="markdown-toc-certicates">Certicates</a></li> <li><a href="#conflicting-powershell-commands" id="markdown-toc-conflicting-powershell-commands">Conflicting powershell commands</a></li> <li><a href="#comparing-nested-objects" id="markdown-toc-comparing-nested-objects">Comparing nested objects</a></li> <li><a href="#write-host-host-console-wtf" id="markdown-toc-write-host-host-console-wtf">Write-host host console wtf?</a></li> <li><a href="#verbose-perference" id="markdown-toc-verbose-perference">Verbose perference</a></li> <li><a href="#classes" id="markdown-toc-classes">Classes</a></li> <li><a href="#catching-errors-with--erroraction" id="markdown-toc-catching-errors-with--erroraction">Catching errors with -erroraction</a></li> </ul> </li> </ul> <p>Everything in powershell is an object. Which means it has a type. The typing system can be quite tricky because it’s dynamic. And also powershell will do a lot for you to try to help make things less verbose.</p> <p>Because powershell is a shell, (as well as a scripting language), it outputs all evaluations of expressions to stdout. This makes it different from say python, where you need to explicitly call a print statement. For powershell, this even applies inside functions. The return value of a function is more like a control-flow keyword. IF you store the output/return-value of a function, you’re actually going to get anything that was printed to stdout and not explicitly caught. Explicitly catching output going to the stdout from expression evalution is done by assigning it to a variable or dealing with the output in some other way.</p> <p>The other thing is that powershell runs on the .dotnet runtime and it’s very analogous to c#. So it’s apparently pretty easy to convert c# code into powershell and vice versa. The benefit of c# is that it’ll probably run faster than powershell code.</p> <p>There are a few types of source-code.</p> <p><strong>Cmdlets</strong></p> <p>A command-let is something implementing by a .NET class that derives from the Cmdlet base-class in the powershell sdk. Building a cmdlet requires the powershell sdk, which is freely available. This category of command is compiled into a dynamic link library and then loaded into the powershell process. Basically corresponds to a built-in command. Though anyone can add and create their own.</p> <p><strong>Functions</strong></p> <p>Created in memory and is discarded by the interpeter when it exits. There’s also something called a workflow.</p> <p><strong>Scripts</strong></p> <p>Read from a .ps1 text file and then stored in memory.</p> <p><strong>Native commands (applications)</strong></p> <p>These are just win32 executable that you can call, like choco.exe. They handle their own parameters and output. It also requires another process to load.</p> <h3 id="get-the-type-of-something"> <a href="#get-the-type-of-something" aria-labelledby="get-the-type-of-something" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get the type of something </h3> <p>Types are useful to know what you’re working with. But, in a dynamic language, you tend to care what methods/properties are available and you care less about types, potentially.</p> <p>How to get the type: $object.GetType()</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"helloworld"</span><span class="w">
</span><span class="nv">$hello</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="w">
</span><span class="nv">$hello</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="o">.</span><span class="nf">FullName</span></code></pre></figure> <p>How to get the methods and properties: get-member</p> <p>Becarefull using the get-member. get-member command returns the properties and methods on an object. Useful for discovering what can be accessed on an object.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'helloworld'</span><span class="w">
</span><span class="c"># Find all the methods and properties available on the string $hello
</span><span class="w">
</span><span class="nf">get-member</span><span class="w"> </span><span class="nt">-inputobject</span><span class="w"> </span><span class="nv">$hello</span></code></pre></figure> <p>For a while, I thought you could pipe the variable to the get-member. Which seemed shorter that writing <code class="language-plaintext highlighter-rouge">get-member -inputobject $hello.</code></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'helloworld'</span><span class="w">
</span><span class="nv">$hello</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">get-member</span></code></pre></figure> <p>However, this is pretty dangerous. Let’s say you have an object which is a list, and you want to find the members and properties on the list</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w">
</span><span class="nv">$a</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">get-member</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">TypeName:</span><span class="w"> </span><span class="nx">System.Int32</span><span class="w">
</span><span class="o">...</span></code></pre></figure> <p>This actually has passed an element from the list a, which is an int, and told you the properties/methods on it. Interestingly, because the array is only made up of int, it only printed the methods/properties once rather than three times.</p> <p>If you make the list or collection with different types in the elements, then it seems to print each methods/properties for the different elements.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">'abc'</span><span class="p">,</span><span class="w"> </span><span class="p">@{</span><span class="nx">d</span><span class="o">=</span><span class="nx">5</span><span class="p">}</span><span class="w">
</span><span class="nv">$a</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">get-member</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="c"># prints methods/proprties for the int, string and hashtable. Nice.</span></code></pre></figure> <h3 id="type-literals"> <a href="#type-literals" aria-labelledby="type-literals" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Type literals </h3> <h3 id="arrays"> <a href="#arrays" aria-labelledby="arrays" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Arrays </h3> <p>There actually isn’t a list literal syntax in powershell. In python you can write ‘a = [1,2,3]’, which assign the variable name a to the list of integers.</p> <p>In powershell, strangely, it doesn’t have something like this. But it does, of course, have arrays. Instead, you can do something like this with commands</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span></code></pre></figure> <p>It’ll create the variable a, with the underlying type [object[]], which is a dotnet array.</p> <p>Apparently things in pipelines, since posh v3, will return arrays. This is because people writing pipeline code tend to expect to be working on a list of inputs, and so pipelines should default to returning lists of stuff even if there’s only one element in the array.</p> <p>E.g., this creates a list:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get-childitem</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">where</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">extension</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'.json'</span><span class="p">}</span><span class="w">
</span><span class="c"># the $out is an array, i.e. [object[]]
</span><span class="w">
</span><span class="nv">$out</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="o">.</span><span class="nf">Fullname</span></code></pre></figure> <p>Apparently, all objects have the .Count() method to behave in a puesdo-array type-way for the benefit of pipelines:</p> <p>”"”Since PowerShell v3, any object is treated as a pseudo-array and has a Count property. This is to remove issues where pipelines could return one, or many, objects. The single object case would cause errors in code designed for a collection of many objects.””” from Powershell In Depth, Manning</p> <p><strong>Dangerous arrays</strong></p> <p>In python, if a points to a list, and then b points to a, b actually points to the list. This is the same in powershell.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w">
</span><span class="nv">$b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$a</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$b</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span></code></pre></figure> <p>If you mutate the contents of $a, then $b changes too.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'one'</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$b</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="s1">'one'</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span></code></pre></figure> <p>But this doesn’t hold true in powershell if you reassigns using += or -=, ahh!!</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="w">
</span><span class="nv">$b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">a</span><span class="w">
</span><span class="nv">$a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">4</span><span class="w"> 
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$a</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$b</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span></code></pre></figure> <p>Ahhh! This is because when assignment happens, using +=, powershell copies the list $ points to, adds the new 4 and then points $a to the new list. It doesn’t actually mutate the underlying list. It creates a brand new once at a different memory location. Ahh!! This seems pretty dangerous. Or at least, likely to cause some bugs you haven’t thought about. Hmm….</p> <p>Python doesn’t suffer this problem. Because it mutates the underlying list rather than copy and add on a new list.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">'one'</span>
<span class="k">assert</span> <span class="n">b</span> <span class="o">==</span> <span class="n">a</span>  <span class="c1"># true
</span><span class="n">a</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,]</span>
<span class="k">print</span> <span class="n">a</span>
<span class="k">assert</span> <span class="n">b</span> <span class="o">==</span> <span class="n">a</span>  <span class="c1"># true
</span></code></pre></div></div> <p>You can also creates arrays like this:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="nf">length</span><span class="w">   </span><span class="c"># though this is really evalute the expression ',1' first rather than a special array notation
</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="p">@()</span><span class="o">.</span><span class="nf">length</span><span class="w">  </span><span class="c"># rather than @{} curly-braces for hashtables, it makes sure whatever is return is always an array!
</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">0</span></code></pre></figure> <h3 id="hashtables-dictionaries"> <a href="#hashtables-dictionaries" aria-labelledby="hashtables-dictionaries" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hashtables (dictionaries) </h3> <p>Beautiful hashtables are pretty easy to create and use</p> <p>It begins with @{}, and uses newline to create next entry, where = is used to assign.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">firstname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'donal'</span><span class="w">
    </span><span class="nx">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'mee'</span><span class="w">
    </span><span class="nx">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">999</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># Though this could be truncated to:
</span><span class="w">
</span><span class="nv">$person</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="nx">firstname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'donal'</span><span class="err">;</span><span class="w"> </span><span class="nx">lastname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'mee'</span><span class="err">;</span><span class="w"> </span><span class="nx">age</span><span class="o">=</span><span class="nx">999</span><span class="p">}</span></code></pre></figure> <p>You can do the typical [] to look-up a key in the hashtable, and you can also use the dot property</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$person</span><span class="p">[</span><span class="s1">'firstname'</span><span class="p">]</span><span class="w">
</span><span class="nv">$person</span><span class="o">.</span><span class="nf">lastname</span><span class="w">

</span><span class="c"># Interestingly, this just returns $Null and doesn't throw an error
</span><span class="w">
</span><span class="nv">$person</span><span class="p">[</span><span class="s1">'doesntexit'</span><span class="p">]</span><span class="w">
</span><span class="c"># And key looksup are also case-insenstive
</span><span class="w">
</span><span class="nv">$person</span><span class="p">[</span><span class="s1">'FIRSTNAME'</span><span class="p">]</span></code></pre></figure> <p>The weird thing perhas is that when you want to iterate over a hashtable, the is a bit unnatural.</p> <p>You must explicitly call GetEnumerate() in the for loop. Otherwise, the first and only value return is the entire hashtable itself.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># Weirdness!
</span><span class="w">
</span><span class="c"># reusing person about
</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$pair</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$person</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$pair</span><span class="w">
    </span><span class="nf">count</span><span class="w"> </span><span class="o">++</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="c"># Just prints the entire hashtable 
</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$count</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">

</span><span class="c"># Must explicitly call the enumeration, lord knows why
</span><span class="w">
</span><span class="nv">$count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="c"># reset count
</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$pair</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$person</span><span class="o">.</span><span class="nf">GetEnumerate</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$pair</span><span class="w">
    </span><span class="nf">count</span><span class="w"> </span><span class="o">++</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">prints</span><span class="w"> </span><span class="nx">each</span><span class="w"> </span><span class="nx">pair</span><span class="w"> </span><span class="nx">once</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nx">count</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">3</span></code></pre></figure> <p>There’s also something called an ordered hashtable. Hashtables don’t return their contents in the same order the pairs were placed into the hashtable (unsurprisingly). But you can get this behaviour using the ordered hashtable cast, which is quite cool (like pythons ordered dictionary)</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">ordered</span><span class="p">]</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">1</span><span class="w">
    </span><span class="nx">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">2</span><span class="w">
    </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">3</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="nf">write-host</span><span class="w"> </span><span class="nv">$a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="mi">2</span></code></pre></figure> <p>If you want to extend an existing hashtable</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">1</span><span class="w">
    </span><span class="nx">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$a</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">3</span><span class="p">)</span></code></pre></figure> <h3 id="create-your-own-new-object"> <a href="#create-your-own-new-object" aria-labelledby="create-your-own-new-object" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create your own new object </h3> <p>Classes, in most programming languages, are the means to create new types of objects. However, Powershell seems to be particularly relaxed about the idea of classes. Classes were only introduced in version 5 of the language. The keyword ‘class’ had been reserved for 10 years before this. It took them this long to get around to creating classes! Which is partly because they wanted to do it write and partly because Powershell is happy for users to create objects dynamically.</p> <p>It seems that in particular, the most useful is</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$mything</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="p">@{</span><span class="w">
    </span><span class="nx">Name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s1">'Adam'</span><span class="w">
    </span><span class="nx">Age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">28</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$mything</span><span class="o">.</span><span class="nf">Name</span><span class="w">
</span><span class="nv">$mything</span><span class="o">.</span><span class="nf">Age</span></code></pre></figure> <p><strong>Extending existing objects</strong></p> <p>You can also add or extend a property. Using the Add-Member commandlet.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># Create two new objects
</span><span class="w">
</span><span class="nv">$two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">psobject</span><span class="w">
</span><span class="nv">$two</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Add-Member</span><span class="w"> </span><span class="nt">-MemberType</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">even</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="nv">$three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">psobject</span><span class="w">
</span><span class="nv">$three</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Add-Member</span><span class="w"> </span><span class="nt">-MemberType</span><span class="w"> </span><span class="nx">NoteProperty</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">even</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="c"># Group the objects by whether the even property is true
</span><span class="w">
</span><span class="nv">$two</span><span class="p">,</span><span class="w"> </span><span class="nv">$three</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">group-object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">even</span></code></pre></figure> <p>Be VERY careful with Add-Member. I had initally, and painful tried this for a while. And OMG, it appears that I didn’t quite correct a property on the objects even though it seems like I sort of had…</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># Create two new objects
</span><span class="w">
</span><span class="nv">$two</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">psobject</span><span class="w">
</span><span class="nv">$two</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Add-Member</span><span class="w"> </span><span class="nt">-NotePropertyName</span><span class="w"> </span><span class="nx">even</span><span class="w"> </span><span class="nt">-NotePropertyValue</span><span class="w"> </span><span class="bp">$true</span><span class="w">
</span><span class="nv">$three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">psobject</span><span class="w">
</span><span class="nv">$three</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Add-Member</span><span class="w"> </span><span class="nt">-NotePropertyName</span><span class="w"> </span><span class="nx">even</span><span class="w"> </span><span class="nt">-NotePropertyValue</span><span class="w"> </span><span class="bp">$false</span><span class="w">
</span><span class="c"># Group the objects by whether the even property is true
</span><span class="w">
</span><span class="nv">$two</span><span class="p">,</span><span class="w"> </span><span class="nv">$three</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">group-object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="nx">even</span><span class="w">
</span><span class="err">`</span></code></pre></figure> <p>HANG on. That worked! Wtf… There must be something else going on…</p> <h4 id="copy-an-object"> <a href="#copy-an-object" aria-labelledby="copy-an-object" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Copy an object </h4> <p>You can also copy you own custom objects and potentially other objects. Let’s say you write a function that needs to temporarily mutate the object is it passed. And you don’t want to really mutate the original object.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Nasty-Mutator</span><span class="w"> </span><span class="p">(</span><span class="nv">$thing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$thing</span><span class="o">.</span><span class="nf">symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Mutated!'</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"The thing now is: </span><span class="nv">$thing</span><span class="s2">"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$demon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nt">-typename</span><span class="w"> </span><span class="nx">psobject</span><span class="w"> </span><span class="nt">-property</span><span class="w"> </span><span class="p">@{</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'donal'</span><span class="err">;</span><span class="w"> </span><span class="nx">symbol</span><span class="o">=</span><span class="nx">666</span><span class="p">}</span><span class="w">
</span><span class="nf">Nasty-Mutator</span><span class="w"> </span><span class="nt">-thing</span><span class="w"> </span><span class="nv">$demon</span><span class="w">
</span><span class="nv">$demon</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">No-Mutations</span><span class="w"> </span><span class="p">(</span><span class="nv">$thing</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$thing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$thing</span><span class="o">.</span><span class="nf">psobject</span><span class="o">.</span><span class="nf">copy</span><span class="p">()</span><span class="w">
    </span><span class="nv">$thing</span><span class="o">.</span><span class="nf">symbol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"make me a princess!"</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"The thing now is: </span><span class="nv">$thing</span><span class="s2">"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$frog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nt">-typename</span><span class="w"> </span><span class="nx">psobject</span><span class="w"> </span><span class="nt">-property</span><span class="w"> </span><span class="p">@{</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'princess'</span><span class="err">;</span><span class="w"> </span><span class="nx">symbol</span><span class="o">=</span><span class="nx">7</span><span class="p">}</span><span class="w">
</span><span class="nf">No-Mutations</span><span class="w"> </span><span class="nt">-thing</span><span class="w"> </span><span class="nv">$frog</span><span class="w">
</span><span class="nv">$frog</span></code></pre></figure> <h4 id="compare-object"> <a href="#compare-object" aria-labelledby="compare-object" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Compare Object </h4> <p>Comparing objects in powershell can be a right pain. Largely because it’s hard to know what’s it default comparison operator is between objects and it doesn’t encourage types, so it’s not like you can rely upon controlling comparsion by type.</p> <p>Let’s say you have a complicated type that is your own custom powershell object. Just comparing the two of them, even if they seem to be the same, will produce False.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$thing1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">
</span><span class="nv">$thing2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">

</span><span class="nv">$thing1</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$thing2</span><span class="w">
</span><span class="err">&gt;&gt;</span><span class="nf">False</span></code></pre></figure> <p>Note just how sad this is! In fact, this is sort of like python. If we compared just a straight hashtable rather than via a psobject, then the comparison would be fine. Hang on! That’s actually not correct. Comparing two hashtables that are the same still produces False. Wtf.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$thing1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">
</span><span class="nv">$thing2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">

</span><span class="nv">$thing1</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="nv">$thing2</span><span class="w">
</span><span class="err">&gt;&gt;</span><span class="nf">False</span></code></pre></figure> <p>We can use the explicit Compare-Object, but even it seems to suck balls for hashtables! It doesn’t seem to be able to handle comparing keys and values at the same time…</p> <p>There is the Compare-Object which seems to work…. for something like a PSObject</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">
</span><span class="nv">$y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">PSOBject</span><span class="p">]@{</span><span class="nx">a</span><span class="o">=</span><span class="s1">'hello'</span><span class="err">;</span><span class="w"> </span><span class="nx">b</span><span class="o">=</span><span class="s1">'world'</span><span class="p">}</span><span class="w">
</span><span class="nf">Compare-Object</span><span class="w"> </span><span class="nv">$x</span><span class="w"> </span><span class="nv">$y</span></code></pre></figure> <h3 id="enumerations"> <a href="#enumerations" aria-labelledby="enumerations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enumerations </h3> <p>In powershell v5, enumerations were added. Before that, posh users had to create enumerations using c#.</p> <p>For background, see these two articles:</p> <ul> <li><a href="https://devblogs.microsoft.com/scripting/working-with-enums-in-powershell-5/">https://devblogs.microsoft.com/scripting/working-with-enums-in-powershell-5/</a></li> <li><a href="https://devblogs.microsoft.com/scripting/new-powershell-5-feature-enumerations/">https://devblogs.microsoft.com/scripting/new-powershell-5-feature-enumerations/</a></li> </ul> <p>An enumeration can now be created like:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">Enum</span><span class="w"> </span><span class="nf">Stuff</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">Apple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">
    </span><span class="nf">Bear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">33</span><span class="w">
    </span><span class="nf">David</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">666</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>The weird thing is that it’s a bit hard to get the values of the enumeration. Anyway, Stuff becomes a new type.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="kt">Stuff</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="kt">Stuff</span><span class="p">]::</span><span class="nf">Apple</span><span class="w">
</span><span class="p">[</span><span class="kt">Stuff</span><span class="p">]::</span><span class="nf">Bear</span></code></pre></figure> <p>The weird thing is each enumeration has a value__ property. Yes that really is a double underscore. Fuck me! Why did powershell do that? I have no idea.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">[</span><span class="kt">Stuff</span><span class="p">]:</span><span class="nf">Apple.value__</span><span class="w">  </span><span class="c"># will print 10</span></code></pre></figure> <p>To iterate over the enumeration, you need to use a method on [Enum] type.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># or could write [enum]::GetValues([type]$enum)
</span><span class="w">
</span><span class="kr">ForEach</span><span class="w"> </span><span class="p">(</span><span class="nv">$thing</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="p">[</span><span class="kt">enum</span><span class="p">]::</span><span class="nf">GetValue</span><span class="p">([</span><span class="kt">Stuff</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$thing</span><span class="p">,</span><span class="w"> </span><span class="nv">$thing</span><span class="o">.</span><span class="nf">value__</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>So let’s say you want to find all the things in a particular enumeration, say the powerpoint file type enumeration</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># Might first have to import the assembly, or have it done for you like
</span><span class="w">
</span><span class="c"># $ppt = New-Object -ComObject 'Powerpoint.Application'
</span><span class="w">
</span><span class="nv">$enum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Enum</span><span class="p">][</span><span class="no">Microsoft.Office.Interop.Powerpoint.</span><span class="kt">PpSaveAsFileType</span><span class="p">]</span><span class="w">
</span><span class="nv">$pptStuff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{}</span><span class="w">
</span><span class="kr">ForEach</span><span class="w"> </span><span class="p">(</span><span class="bp">$_</span><span class="nf">e</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="p">[</span><span class="kt">enum</span><span class="p">]::</span><span class="nx">getvalue</span><span class="p">(</span><span class="nv">$enum</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nv">$pptStuff</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="bp">$_</span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="bp">$_</span><span class="nx">e.value__</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$pptStuff</span></code></pre></figure> <h3 id="parameters"> <a href="#parameters" aria-labelledby="parameters" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Parameters </h3> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># At the top of a script, or function, place
</span><span class="w">
</span><span class="kr">Param</span><span class="p">(</span><span class="w">
    </span><span class="p">[</span><span class="kt">Parameter</span><span class="p">(</span><span class="kt">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">,</span><span class="w"> </span><span class="kt">Position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kt">HelpMessage</span><span class="o">=</span><span class="s2">"First param called first"</span><span class="p">)]</span><span class="w">
    </span><span class="nv">$First</span><span class="p">,</span><span class="w"> </span><span class="c"># comma between parameters, params are capital case by convention
</span><span class="w">
    </span><span class="p">[</span><span class="kt">Parameter</span><span class="p">(</span><span class="kt">HelpMessage</span><span class="o">=</span><span class="s2">"Second Param has a default value"</span><span class="p">)]</span><span class="w">
    </span><span class="nv">$Second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"myDefault"</span><span class="p">,</span><span class="w">
    </span><span class="p">[</span><span class="kt">switch</span><span class="p">]</span><span class="nv">$Flag</span><span class="p">,</span><span class="w"> </span><span class="c"># switch parameter
</span><span class="w">
</span><span class="p">)</span></code></pre></figure> <p>Parameters are pretty interesting in powershell. There is something in the interpreter called the parameter binder. This is responsible for converting parameters (names of arguments) and arguments (the value itself) into a sensible type. Powershell is pretty generous. The parameter binder will try to convert values to required values. Etc.</p> <h3 id="splatting"> <a href="#splatting" aria-labelledby="splatting" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Splatting </h3> <p>Splatting is a nice way to feed params to a command. It’s like pythons unpacking <code class="language-plaintext highlighter-rouge">hello(*pass)</code>. Let’s say there is a command I call in the same place with the same options. I don’t want to repeat those arguments each time, or at least, manually.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># create an array of the options
</span><span class="w">
</span><span class="c"># we could use a hash table to do keywords
</span><span class="w">
</span><span class="nv">$gitOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"git"</span><span class="p">,</span><span class="w"> </span><span class="s2">"--params"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/GitOnlyOnPath /NoGitLfs /SChannel /NoShellIntegration"</span><span class="w">
</span><span class="c"># and then we unpack, we goes in the order unpacked
</span><span class="w">
</span><span class="nf">choco</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nt">-y</span><span class="w"> </span><span class="err">@</span><span class="nx">gitOptions</span></code></pre></figure> <h3 id="copying-files-and-folders"> <a href="#copying-files-and-folders" aria-labelledby="copying-files-and-folders" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Copying files and folders </h3> <p>Perhaps you want to copy the contents of a directory into the current directory.</p> <p>This will copy all the contents of the remote directory into the current directory. The -recurse is pretty important, otherwise, you’ll get just the top level of the files. The next handy feature is the star. Without the star, you get the contents of the ‘copy’ directory as a new directory in the current working directory.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># get-alias -name cp
</span><span class="w">
</span><span class="c"># get-alias -definition copy-item
</span><span class="w">
</span><span class="nf">copy-item</span><span class="w"> </span><span class="nx">the\folder\to\copy\</span><span class="o">*</span><span class="w"> </span><span class="nt">-recurse</span></code></pre></figure> <h3 id="find-files-in-a-directory"> <a href="#find-files-in-a-directory" aria-labelledby="find-files-in-a-directory" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Find files in a directory </h3> <p>It’s pretty typical that you’ll have a directory, and you want to look for a particular file. Perhaps you want to find just the json files.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># the -file parameter means don't consider directories to be items themselves, which isn't strictly necessary
</span><span class="w">
</span><span class="nf">get-childitem</span><span class="w"> </span><span class="nt">-recurse</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">\folder\to\search\</span><span class="w"> </span><span class="nt">-filter</span><span class="w"> </span><span class="s2">".json"</span><span class="w"> </span><span class="nt">-File</span></code></pre></figure> <p>While filter is efficient, it isn’t that flexible (other than wildcards), because it’s limited to filtering on 1 critera. But perhaps you want to filter off and .log, .png, and .txt files, and then get whatever is left. Welcome the <code class="language-plaintext highlighter-rouge">where-object</code> command, which is like select-string except it drops any object that doesn’t match the criteria.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># get-alias -definition get-childitem -&gt; ls
</span><span class="w">
</span><span class="c"># get-alias -definition where-object -&gt; where, ?
</span><span class="w">
</span><span class="c"># this command says get every file within the search folder, and then drop any files with extensions .json or .png or .log
</span><span class="w">
</span><span class="nf">get-childitem</span><span class="w"> </span><span class="nt">-recurse</span><span class="w"> </span><span class="nt">-file</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">\folder\to\search</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">where-object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">extension</span><span class="w"> </span><span class="nt">-NotIn</span><span class="w"> </span><span class="s2">".json"</span><span class="p">,</span><span class="w"> </span><span class="s2">".png"</span><span class="p">,</span><span class="w"> </span><span class="s2">".log"</span><span class="p">}</span><span class="w">
</span><span class="c"># equivalent to this
</span><span class="w">
</span><span class="nf">ls</span><span class="w"> </span><span class="nt">-recurse</span><span class="w"> </span><span class="nt">-file</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">\folder\to\search</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">extension</span><span class="w"> </span><span class="nt">-NotIn</span><span class="w"> </span><span class="s2">".json"</span><span class="p">,</span><span class="w"> </span><span class="s2">".png"</span><span class="p">,</span><span class="w"> </span><span class="s2">".log"</span><span class="p">}</span></code></pre></figure> <h3 id="get-event-logs-from-the-system"> <a href="#get-event-logs-from-the-system" aria-labelledby="get-event-logs-from-the-system" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get event logs from the system! </h3> <ul> <li>Creating a boottime when the machine started today</li> <li>Then getting all the error logs</li> </ul> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$boottime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get-date</span><span class="w"> </span><span class="nt">-year</span><span class="w"> </span><span class="nx">2019</span><span class="w"> </span><span class="nt">-month</span><span class="w"> </span><span class="nx">3</span><span class="w"> </span><span class="nt">-day</span><span class="w"> </span><span class="nx">12</span><span class="w"> </span><span class="nt">-hour</span><span class="w"> </span><span class="nx">09</span><span class="w"> </span><span class="nt">-minute</span><span class="w"> </span><span class="nx">44</span><span class="w">
</span><span class="nf">get-eventlog</span><span class="w"> </span><span class="nt">-logname</span><span class="w"> </span><span class="nx">system</span><span class="w"> </span><span class="nt">-after</span><span class="w"> </span><span class="nt">-entrytype</span><span class="w"> </span><span class="nx">Error</span></code></pre></figure> <ul> <li>This prints a summary of the log information. But we might want to see everything. Do this:</li> </ul> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">get-eventlog</span><span class="w"> </span><span class="nt">-logname</span><span class="w"> </span><span class="nx">system</span><span class="w"> </span><span class="nt">-after</span><span class="w"> </span><span class="nt">-entrytype</span><span class="w"> </span><span class="nx">Error</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Select-Object</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="o">*</span></code></pre></figure> <h3 id="grep-for-lines-in-a-text-file"> <a href="#grep-for-lines-in-a-text-file" aria-labelledby="grep-for-lines-in-a-text-file" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grep for lines in a text file </h3> <p>Or perhaps your trying to select lines with particular string? This prints out all lines with ‘success’.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">get-content</span><span class="w"> </span><span class="nv">$filename</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">select-string</span><span class="w"> </span><span class="s2">"success"</span><span class="w">
</span><span class="c"># The alias for select-string is 'sls'</span></code></pre></figure> <p>The select-string actually has some quite nice in-built functionality to search across directories or files. You can combine this:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># Look through all the files in logfiles directory, drop any files not ending in .log, get the contents of the file
</span><span class="w">
</span><span class="c"># and then search the contents for 'success'
</span><span class="w">
</span><span class="nf">get-childitem</span><span class="w"> </span><span class="nx">\path\to\logfiles</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">where-object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">extension</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s2">".log"</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">get-content</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">select-string</span><span class="w"> </span><span class="s2">"success"</span></code></pre></figure> <p>In just one call</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">select-string</span><span class="w"> </span><span class="nt">-path</span><span class="w"> </span><span class="nx">\path\to\logfiles</span><span class="o">*.</span><span class="nf">log</span><span class="w"> </span><span class="nt">-pattern</span><span class="w"> </span><span class="s2">"success"</span></code></pre></figure> <h3 id="get-the-date"> <a href="#get-the-date" aria-labelledby="get-the-date" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Get the date! </h3> <p>This prints the date now, which I think using some system type</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">$</span><span class="p">([</span><span class="kt">DateTime</span><span class="p">]::</span><span class="nf">Now</span><span class="p">)</span></code></pre></figure> <p>But there is a whole powershell commandlet for it</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># prints date &amp; time in a timestamp format, though not suitable for filenames
</span><span class="w">
</span><span class="nf">Get-Date</span><span class="w"> </span><span class="nt">-Format</span><span class="w"> </span><span class="nx">o</span><span class="w">
</span><span class="c"># custom one for filenames
</span><span class="w">
</span><span class="nf">Get-Date</span><span class="w"> </span><span class="nt">-UFormat</span><span class="w"> </span><span class="s2">"%Y-%m-%d_%Hh%Mm%Ssec"</span></code></pre></figure> <h3 id="mark-as-script-as-admin-only"> <a href="#mark-as-script-as-admin-only" aria-labelledby="mark-as-script-as-admin-only" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Mark as script as admin only </h3> <p>Quite a few scripts will require administrator privileges to be effective. Powershell provides a way to mark a script as needing higher privileges. You can use this directive. It a lot of ways it looks like a comment, but it isn’t without an effective. Put it at the top of the script.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c">#Requires -RunAsAdministrator</span></code></pre></figure> <h3 id="create-an-background-job"> <a href="#create-an-background-job" aria-labelledby="create-an-background-job" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create an background job </h3> <ul> <li>Creating a background job to cp test result into investigating dir. Note, I’ve already set $invest</li> <li>Start-Job pwd is not the cwd. It’s cwd is in your Documents folder for some reason.</li> </ul> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Start-Job</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="nf">cp</span><span class="w"> </span><span class="nt">-recurse</span><span class="w"> </span><span class="nx">\\</span><span class="err">&lt;</span><span class="nx">filepath</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$invest</span><span class="p">}</span><span class="w">
</span><span class="c"># This will get information about status of the background job
</span><span class="w">
</span><span class="nf">Get-Job</span><span class="w"> </span><span class="nt">-Id</span><span class="w"> </span><span class="nx">1</span></code></pre></figure> <ul> <li>ExpertT also suggested trying asychronous cp alternative <code class="language-plaintext highlighter-rouge">get-command -noun bitstransfer</code></li> </ul> <h3 id="debugging"> <a href="#debugging" aria-labelledby="debugging" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debugging </h3> <p>Commands:</p> <ul> <li>Enter-PSHost <ul> <li>This allows you to grab other powershell process and begin debugging them. You cannot debug the process this is invoked in. It is only for other powershell processes. Not the current one.</li> </ul> </li> <li>Debug-Runspace <ul> <li>Not sure what this does. But I think that multiple powershell processes can be hosted in a single runspace, or something. Again, you can’t debug the ‘default’ or current runspace which you can find through “$ExecutionContext.Host.Runspace”.</li> </ul> </li> <li>Set-PSDebug -Trace 1 <ul> <li>Doesn’t start an interactve debugger but does trace every call. Which is very useful.</li> </ul> </li> <li>Set-PSDebug -Step <ul> <li>This is the normal stepwise debugger! Yes!</li> </ul> </li> </ul> <p>To stop the debugger type</p> <ul> <li>Set-PSDebug -off</li> </ul> <p>This will trace how the parameters are bound in the expression. Parameter binding in powershell is quite complicated.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Trace-Command</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">ParameterBinding</span><span class="w">  </span><span class="nt">-Option</span><span class="w"> </span><span class="nx">All</span><span class="w"> </span><span class="nt">-Expression</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Write-Output</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nt">-PSHost</span></code></pre></figure> <p>Actually <a href="https://devblogs.microsoft.com/scripting/use-the-powershell-debugger-to-troubleshoot-scripts/">this article</a> perhaps is most useful, if you want to run the code and then let it hit the exception.</p> <p>You can use <code class="language-plaintext highlighter-rouge">Set-PSBreakPoint</code> to set a line on a script that will trigger the debugger.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Set-PSBreakpoint</span><span class="w"> </span><span class="nt">-Script</span><span class="w"> </span><span class="o">.</span><span class="nx">\wake-on-lan.ps1</span><span class="w"> </span><span class="nt">-Line</span><span class="w"> </span><span class="nx">64</span><span class="w">
</span><span class="c"># then just run the script
</span><span class="w">
</span><span class="o">.</span><span class="nf">\wake-on-lan.ps1</span><span class="w">
</span><span class="c"># and at line 64 the debugger will open, use ? or h to get the help for the debugger.</span></code></pre></figure> <h4 id="tracingcapturing-session-output-with-a-transcript"> <a href="#tracingcapturing-session-output-with-a-transcript" aria-labelledby="tracingcapturing-session-output-with-a-transcript" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tracing/Capturing session output with a transcript </h4> <p>Sometimes, especially with remote machines and when you’re calling powershell through some third party like ruby, you want a way to record what the is happening when you run a script and you want to store all the output you see at the console.</p> <p>You can use <code class="language-plaintext highlighter-rouge">Start-Transcript</code> and <code class="language-plaintext highlighter-rouge">Stop-Transcript</code> and point the transcript to a file, like <code class="language-plaintext highlighter-rouge">Start-Transcript -Path 'posh.log'</code></p> <h3 id="error-behaviour"> <a href="#error-behaviour" aria-labelledby="error-behaviour" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Error behaviour </h3> <p>The default behaviour of powershell - unlike python - is to continue if it hits an error. This is actually somewhat sane given it’s a system admin shell. The sensitivity of python to exceptions can make it fiddly and certainly more likely to stop doing work that could be useful.</p> <p>However, Powershell provides the user with a way to control the error behaviour by setting a session variable called the ErrorActionPerference. The variable determines whether to treat unhandled errors as terminating or non-terminating errors.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ErrorActionPreference = "Stop"  # Or one of 'Continue', 'SilentlyContinue', 'Stop', 'Inquire', 'Suspend'
</code></pre></div></div> <h4 id="terminating-errors"> <a href="#terminating-errors" aria-labelledby="terminating-errors" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Terminating errors </h4> <p>Terminating errors are very important and a potential trip-up. Just because something appears to write an error does not mean it is a terminating error. A terminating error in powershell is one that will throw an unhandled exception and will stop your program unless it’s caught by a try catch. However, most?/many errors in powershell are <strong>non-terminating</strong> by default. For good reason, because powershell wants your code to do as much work as possible.</p> <p>However, observe:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">C:\dev\repo</span><span class="w"> </span><span class="p">[</span><span class="kt">donal_branch</span><span class="w"> </span><span class="err">≡</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="nf">~0</span><span class="w"> </span><span class="nt">-0</span><span class="w"> </span><span class="o">!</span><span class="p">]</span><span class="err">&gt;</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w">
</span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">The</span><span class="w"> </span><span class="kt">specified</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">not</span><span class="w"> </span><span class="kt">loaded</span><span class="w"> </span><span class="kt">because</span><span class="w"> </span><span class="kt">no</span><span class="w"> </span><span class="kt">valid</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="kt">file</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">found</span><span class="w"> </span><span class="kt">in</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="no">directory.</span><span class="w">
</span><span class="kt">At</span><span class="w"> </span><span class="kt">line</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="kt">char</span><span class="p">:</span><span class="mi">1</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="nf">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="kt">ResourceUnavailable</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">DOES</span><span class="w"> </span><span class="kt">NOT</span><span class="w"> </span><span class="kt">EXIST</span><span class="p">:</span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="kt">Import</span><span class="nt">-Module</span><span class="p">],</span><span class="w"> </span><span class="kt">FileNotFoundException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">Modules_ModuleNotFound</span><span class="p">,</span><span class="no">Microsoft.PowerShell.Commands.</span><span class="kt">ImportModuleCommand</span><span class="w">

</span><span class="nf">C:\dev\repo</span><span class="w"> </span><span class="p">[</span><span class="kt">donal_branch</span><span class="w"> </span><span class="err">≡</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="nf">~0</span><span class="w"> </span><span class="nt">-0</span><span class="w"> </span><span class="o">!</span><span class="p">]</span><span class="err">&gt;</span><span class="w"> </span><span class="kt">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="p">}</span><span class="w"> </span><span class="kt">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">write</span><span class="nt">-host</span><span class="w"> </span><span class="s1">'Hello from the catch'</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">The</span><span class="w"> </span><span class="kt">specified</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">not</span><span class="w"> </span><span class="kt">loaded</span><span class="w"> </span><span class="kt">because</span><span class="w"> </span><span class="kt">no</span><span class="w"> </span><span class="kt">valid</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="kt">file</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">found</span><span class="w"> </span><span class="kt">in</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="no">directory.</span><span class="w">
</span><span class="kt">At</span><span class="w"> </span><span class="kt">line</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="kt">char</span><span class="p">:</span><span class="mi">7</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kt">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="p">}</span><span class="w"> </span><span class="kt">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">write</span><span class="nt">-host</span><span class="w"> </span><span class="s1">'Hello from  ...
+       ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (DOES NOT EXIST:String) [Import-Module], FileNotFoundException
    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand

C:\dev\repo [donal_branch ≡ +2 ~0 -0 !]&gt; try { 1/0 } catch { write-host '</span><span class="kt">Hello</span><span class="w"> </span><span class="kt">from</span><span class="w"> </span><span class="kt">the</span><span class="w"> </span><span class="kt">catch</span><span class="s1">' }
Hello from the catch
C:\dev\repo [donal_branch ≡ +2 ~0 -0 !]&gt; $error[0]
Attempted to divide by zero.
At line:1 char:7
+ try { 1/0 } catch { write-host '</span><span class="kt">Hello</span><span class="w"> </span><span class="kt">from</span><span class="w"> </span><span class="kt">the</span><span class="w"> </span><span class="kt">catch</span><span class="s1">' }
+       ~~~
    + CategoryInfo          : NotSpecified: (:) [], RuntimeException
    + FullyQualifiedErrorId : RuntimeException

C:\dev\repo [donal_branch ≡ +2 ~0 -0 !]&gt; $error[1]
Import-Module : The specified module '</span><span class="kt">DOES</span><span class="w"> </span><span class="kt">NOT</span><span class="w"> </span><span class="kt">EXIST</span><span class="s1">' was not loaded because no valid module file was found in any module directory.
At line:1 char:7
+ try { Import-Module '</span><span class="kt">DOES</span><span class="w"> </span><span class="kt">NOT</span><span class="w"> </span><span class="kt">EXIST</span><span class="s1">'} catch { write-host '</span><span class="kt">Hello</span><span class="w"> </span><span class="kt">from</span><span class="w">  </span><span class="o">...</span><span class="w">
</span><span class="o">+</span><span class="w">       </span><span class="nf">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="kt">ResourceUnavailable</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">DOES</span><span class="w"> </span><span class="kt">NOT</span><span class="w"> </span><span class="kt">EXIST</span><span class="p">:</span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="kt">Import</span><span class="nt">-Module</span><span class="p">],</span><span class="w"> </span><span class="kt">FileNotFoundException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">Modules_ModuleNotFound</span><span class="p">,</span><span class="no">Microsoft.PowerShell.Commands.</span><span class="kt">ImportModuleCommand</span><span class="w">

</span><span class="nf">C:\dev\repo</span><span class="w"> </span><span class="p">[</span><span class="kt">donal_branch</span><span class="w"> </span><span class="err">≡</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="nf">~0</span><span class="w"> </span><span class="nt">-0</span><span class="w"> </span><span class="o">!</span><span class="p">]</span><span class="err">&gt;</span><span class="w"> </span><span class="kt">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="kt">stop</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kt">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">write</span><span class="nt">-host</span><span class="w"> </span><span class="s1">'Hello from the catch'</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="kt">Hello</span><span class="w"> </span><span class="kt">from</span><span class="w"> </span><span class="kt">the</span><span class="w"> </span><span class="kt">catch</span><span class="w">
</span><span class="nf">C:\dev\repo</span><span class="w"> </span><span class="p">[</span><span class="kt">donal_branch</span><span class="w"> </span><span class="err">≡</span><span class="w"> </span><span class="o">+</span><span class="mi">2</span><span class="w"> </span><span class="nf">~0</span><span class="w"> </span><span class="nt">-0</span><span class="w"> </span><span class="o">!</span><span class="p">]</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">
</span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">The</span><span class="w"> </span><span class="kt">specified</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">not</span><span class="w"> </span><span class="kt">loaded</span><span class="w"> </span><span class="kt">because</span><span class="w"> </span><span class="kt">no</span><span class="w"> </span><span class="kt">valid</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="kt">file</span><span class="w"> </span><span class="kt">was</span><span class="w"> </span><span class="kt">found</span><span class="w"> </span><span class="kt">in</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="kt">module</span><span class="w"> </span><span class="no">directory.</span><span class="w">
</span><span class="kt">At</span><span class="w"> </span><span class="kt">line</span><span class="p">:</span><span class="mi">1</span><span class="w"> </span><span class="kt">char</span><span class="p">:</span><span class="mi">7</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="kt">try</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">Import</span><span class="nt">-Module</span><span class="w"> </span><span class="s1">'DOES NOT EXIST'</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="kt">stop</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kt">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">writ</span><span class="w"> </span><span class="o">...</span><span class="w">
</span><span class="o">+</span><span class="w">       </span><span class="nf">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="kt">ResourceUnavailable</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="kt">DOES</span><span class="w"> </span><span class="kt">NOT</span><span class="w"> </span><span class="kt">EXIST</span><span class="p">:</span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="kt">Import</span><span class="nt">-Module</span><span class="p">],</span><span class="w"> </span><span class="kt">FileNotFoundException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="kt">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kt">Modules_ModuleNotFound</span><span class="p">,</span><span class="no">Microsoft.PowerShell.Commands.</span><span class="kt">ImportModuleCommand</span></code></pre></figure> <p>Note, the importance of this:</p> <ul> <li>Just because an error occurs inside a try/catch does not mean it’s always going to trigger the catch</li> <li>Some types of errors default to be terminating (i.e. divide by zero)</li> <li>Other types of errors default to be non-terminating (like the import-module)</li> <li>For cmdlets, you can use the -ErrorAction to make a non-terminating error terminating</li> </ul> <p>There is an discussion about this online at <a href="https://github.com/MicrosoftDocs/Powershell-Docs/issues/1583">https://github.com/MicrosoftDocs/Powershell-Docs/issues/1583</a></p> <h4 id="exception-does-not-print-line-error-occurred"> <a href="#exception-does-not-print-line-error-occurred" aria-labelledby="exception-does-not-print-line-error-occurred" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exception does not print line error occurred? </h4> <p>My shell, I put in:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Badness</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="kt">Parameter</span><span class="p">(</span><span class="kt">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="nv">$Url</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="nf">Nested</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="nv">$Url</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">Nested</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="p">(</span><span class="nv">$Url</span><span class="p">)</span><span class="w">
    </span><span class="nf">Invoke-RestMethod</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="nv">$Url</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nf">Badness</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="s1">'www.google.com'</span></code></pre></figure> <p>ExpertT’s shell showed, and he said <em>“the error stack is very nice because even if something deep down a call emits an error, it’ll be in the error stack which means you don’t necessarily have to redo the erroring operation with a debugger or add logging a snippet of the error record automatically rendered in my shell:”</em></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="p">(</span><span class="mi">109</span><span class="p">)</span><span class="nf">C:\dev\repo</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Badness</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="s1">'www.google.com'</span><span class="w">
</span><span class="nf">Invoke-RestMethod</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="nx">parameter</span><span class="w"> </span><span class="nx">cannot</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">found</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="nx">parameter</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="s1">'Url'</span><span class="o">.</span><span class="w">
</span><span class="nf">At</span><span class="w"> </span><span class="nx">line:10</span><span class="w"> </span><span class="nx">char:23</span></code></pre></figure> <p>…<em>Which is what you wanted to see? and the error record has the useful invocationinfo property as we explored earlier also another property:</em></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="w"> </span><span class="nv">$e</span><span class="o">.</span><span class="nf">ScriptStackTrace</span><span class="w">
</span><span class="nf">at</span><span class="w"> </span><span class="nx">Nested</span><span class="p">,</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">No</span><span class="w"> </span><span class="nx">file</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="nx">10</span><span class="w">
</span><span class="nf">at</span><span class="w"> </span><span class="nx">Badness</span><span class="p">,</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">No</span><span class="w"> </span><span class="nx">file</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="nx">6</span><span class="w">
</span><span class="nf">at</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">ScriptBlock</span><span class="err">&gt;</span><span class="p">,</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">No</span><span class="w"> </span><span class="nx">file</span><span class="err">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="nx">1</span></code></pre></figure> <p><em>…Which is useful too inside the errorrecord object is also the exception…(object, OF COURSE): ExpertT: an interesting property on that</em></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="nv">$e</span><span class="o">.</span><span class="nf">Exception</span><span class="o">.</span><span class="nf">targetsite</span><span class="w">
</span><span class="nf">Name</span><span class="w">                       </span><span class="p">:</span><span class="w"> </span><span class="nx">VerifyArgumentsProcessed</span><span class="w">
</span><span class="nf">DeclaringType</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">System.Management.Automation.CmdletParameterBinderController</span><span class="w">
</span><span class="nf">ReflectedType</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">System.Management.Automation.CmdletParameterBinderController</span><span class="w">
</span><span class="nf">MemberType</span><span class="w">                 </span><span class="p">:</span><span class="w"> </span><span class="nx">Method</span><span class="w">
</span><span class="nf">MetadataToken</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">100671752</span><span class="w">
</span><span class="kr">Module</span><span class="w">                     </span><span class="p">:</span><span class="w"> </span><span class="nf">System.Management.Automation.dll</span><span class="w">
</span><span class="o">...</span><span class="w"> </span><span class="c">## snipped</span></code></pre></figure> <p><em>…which looks like it is showing the parameter binding exception”.</em></p> <p>Donal said <em>“That isn’t what my shell shows. It shows:”</em></p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">C:\Users\donal.mee</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Badness</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="s1">'www.google.com'</span><span class="w">
</span><span class="nf">Badness</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">A</span><span class="w"> </span><span class="nx">parameter</span><span class="w"> </span><span class="nx">cannot</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">found</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="nx">parameter</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="s1">'Url'</span><span class="o">.</span><span class="w">
</span><span class="nf">At</span><span class="w"> </span><span class="nx">line:1</span><span class="w"> </span><span class="nx">char:1</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="nf">Badness</span><span class="w"> </span><span class="nt">-Url</span><span class="w"> </span><span class="s1">'www.google.com'</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="nf">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nf">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">InvalidArgument:</span><span class="w"> </span><span class="p">(:)</span><span class="w"> </span><span class="p">[</span><span class="kt">Badness</span><span class="p">],</span><span class="w"> </span><span class="nf">ParameterBindingException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nf">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">NamedParameterNotFound</span><span class="p">,</span><span class="nx">Badness</span></code></pre></figure> <p>ExpertT says <em>“I suspect you have $ErrorActionPreference=’stop’ which is not a canonical way to drive the pipeline so I recommend you set it to Continue the idea is usually to drive a pipeline as much as you can, then collect errorrecords and decide if you want to retry or not or do something alternative the idea isn’t usually to panic and stop. the difference between ‘ignore’ and ‘silentlycontinue’ is whether an errorrecord is popped onto the error stack. You will find that the type of object you get back off the errorstack differs when erroractionpreference=’stop’. System.Management.Automation.CmdletInvocationException  vs  System.Management.Automation.ErrorRecord”</em></p> <h3 id="catching-an-exception"> <a href="#catching-an-exception" aria-labelledby="catching-an-exception" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Catching an exception </h3> <p>When powershell writes an error to stdout, it often gives it name that you can’t then catch. What? I must not understand something about powershell exceptions. For example, ls a directory that doesn’t exist.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\dev\infra [master ↑3 +0 ~4 -1 | +10 ~3 -0 !]&gt; ls __init__.pycas
ls : Cannot find path 'C:\dev\infra\__init__.pycas' because it does not exist.
At line:2 char:1
+ ls .\__init__.pycas
+ ~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: (C:\dev\infra\__init__.pycas:String) [Get-ChildItem], ItemNotFoundException
    + FullyQualifiedErrorId : PathNotFound,Microsoft.PowerShell.Commands.GetChildItemCommand
</code></pre></div></div> <p>You’d think you could catch this with something like this</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">ls</span><span class="w"> </span><span class="o">.</span><span class="nx">\__init__.pycas</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">catch</span><span class="w"> </span><span class="p">[</span><span class="no">Microsoft.PowerShell.Commands.</span><span class="kt">GetChildItemCommand</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"caught!"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Alas not! The ErrorID is not the thing to catch. Not is <code class="language-plaintext highlighter-rouge">[ItemNotFound]</code> or anything else in the stdout. Ahh!</p> <p>However, there is a way to discover the error type to catch and the error type to catch is suprising.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">ls</span><span class="w"> </span><span class="o">.</span><span class="nx">\__init__.pycas</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="bp">$_</span><span class="o">.</span><span class="nf">exception</span><span class="o">.</span><span class="nf">gettype</span><span class="p">()</span><span class="o">.</span><span class="nf">fullname</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Which will print <code class="language-plaintext highlighter-rouge">System.Management.Automation.ItemNotFoundException</code>. WTF! Yeah. So to catch this you’d write</p> <p>There’s also the error exception stack. Which has the last errors on the stack.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="nv">$e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$error</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w">  </span><span class="c"># get the most error
</span><span class="w">
</span><span class="err">&gt;</span><span class="nv">$e</span><span class="o">.</span><span class="nf">Exception</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="o">.</span><span class="nf">fullname</span><span class="w">
</span><span class="nf">System.Management.Automation.ItemNotFoundException</span></code></pre></figure> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">ls</span><span class="w"> </span><span class="o">.</span><span class="nx">\__init__.pycas</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="kr">catch</span><span class="w"> </span><span class="p">[</span><span class="no">System.Management.Automation.</span><span class="kt">ItemNotFoundException</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"finally caught!"</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p><strong>Note!</strong> Just because something is in the <code class="language-plaintext highlighter-rouge">$error</code> stack it does not mean it was a <em>terminating</em> error and you writing try/catch will not neccessarily catch it. See above on terminating errors.</p> <h3 id="throwing-exceptions"> <a href="#throwing-exceptions" aria-labelledby="throwing-exceptions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Throwing exceptions </h3> <p>Perhaps you want to throw an exception. Why wouldn’t you? This is were the <code class="language-plaintext highlighter-rouge">throw</code> keyword comes in.</p> <p>Let’s say I have been writing a function, but it’s not finished. And I’d like to throw an error if the user tries to call it.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Do-Plumbing</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># We all know Plumbers never finish their work.
</span><span class="w">
    </span><span class="kr">throw</span><span class="w"> </span><span class="p">[</span><span class="no">System.</span><span class="kt">NotImplementedException</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Interesting, the throw can throw any object, like a user message or a string. Lolcats. Yes indeed.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Call-Plumber</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c"># We all know plumbers don't answer their phones either
</span><span class="w">
    </span><span class="kr">throw</span><span class="w"> </span><span class="s2">"This is Dave. I'm not available now. Leave a message."</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>And, like in Powershell, there is a Command-let for everything. There is the Write-Error commandlet. But this just writes to the stderr. It does not generate a terminating error.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">write-error</span><span class="w"> </span><span class="s1">'Well, if you hit an error, why would you want to stop?'</span></code></pre></figure> <h3 id="remote-commands"> <a href="#remote-commands" aria-labelledby="remote-commands" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Remote commands </h3> <p>There is a pretty detailed PS doc section <a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-5.1">here</a></p> <ul> <li><a href="https://www.youtube.com/watch?v=PMRkM9jlMMw">Tutorial on remoting</a></li> <li><a href="https://www.youtube.com/watch?v=MyQGk29w-BM">Overview of remoting</a></li> </ul> <p>Needs to be enabled on the remote machine first, and you also need to enable remoting on the client.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Enable-PSRemoting</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="c"># There is also the older but I guess almost equivalent
</span><span class="w">
</span><span class="nf">winrm</span><span class="w"> </span><span class="nx">quickconfig</span><span class="w">
</span><span class="c"># This should set the WinRM service to run and enable relevant firewall rules
</span><span class="w">
</span><span class="nf">Get-NetFirewallRule</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="o">*</span><span class="nx">winrm</span><span class="o">*</span></code></pre></figure> <p>Please note that Powershell Remoting is a complicated topic. But WinRM is one of the transport layers that Posh remoting can work over. There are a bunch of others, including SSH.</p> <p>This works provided your on the same AD domain. Otherwise, you’ll need to specify some trusted machines that are allowed to connect. See <a href="https://www.howtogeek.com/117192/how-to-run-powershell-commands-on-remote-computers/">here</a></p> <p>There are quite a number of settings. On the client machine, the relevant area is in</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">ls</span><span class="w"> </span><span class="nx">wsman:localhost\client</span><span class="w">
</span><span class="c"># We can very generously set all possible hosts as trusted.
</span><span class="w">
</span><span class="nf">Set-Item</span><span class="w"> </span><span class="nx">wsman:localhost\client\TrustedHosts</span><span class="w"> </span><span class="o">*</span><span class="w">
</span><span class="c"># Also the relevant authenication methods that are allowed by the client are, set the ones you care about to true
</span><span class="w">
</span><span class="nf">ls</span><span class="w"> </span><span class="nx">wsman:localhost\client\auth</span></code></pre></figure> <ul> <li>Test the connection to the server:</li> </ul> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Test-WsMan</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">COMPUTERNAME</span><span class="err">&gt;</span></code></pre></figure> <p>You may find it’s hard to connect to the computer. This is normally a networking issue. Check whether the machine is on the domain and whether the full-qualified domain host (FQDN) is resolvable. If it is not resolvable, then you can’t use that name to connect to the machine. Instead, you’ll need to use the IP address. Some of the authencation options, like CredSsp, don’t seem to work well with IP addresses.</p> <p>Thus try using default authentication</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$tbhr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Get-Credential</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">username</span><span class="err">&gt;</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s1">'Connecting to machine'</span><span class="w">
</span><span class="c"># Also, note user is an admin on the machine, then you can probably use that account to connect. However, what users are allowed to connect to a machine via RDP is a configurable property.
</span><span class="w">

</span><span class="nv">$donzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-PSSession</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$tbhr</span><span class="w"> </span><span class="nt">-Authentication</span><span class="w"> </span><span class="nx">default</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">10.14.2.213</span><span class="w">
</span><span class="nf">Invoke-Command</span><span class="w"> </span><span class="nt">-Session</span><span class="w"> </span><span class="nv">$donzer</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">dir</span><span class="w"> </span><span class="nx">\</span><span class="w"> </span><span class="p">}</span></code></pre></figure> <p>How to check whether a name is resolvable? nbtstat loops through</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">nbtstat</span><span class="w"> </span><span class="nt">-a</span><span class="w"> </span><span class="nx">machinex.test.corpb.local</span></code></pre></figure> <p>There are also some powershell commands</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="w"> </span><span class="nf">Resolve-DnsName</span><span class="w"> </span><span class="nx">vmaas-466265</span><span class="w">                                              
                                                                                              
</span><span class="nf">Name</span><span class="w">                                           </span><span class="nx">Type</span><span class="w">   </span><span class="nx">TTL</span><span class="w">   </span><span class="nx">Section</span><span class="w">    </span><span class="nx">IPAddress</span><span class="w">              
</span><span class="nf">----</span><span class="w">                                           </span><span class="nf">----</span><span class="w">   </span><span class="nf">---</span><span class="w">   </span><span class="nf">-------</span><span class="w">    </span><span class="nf">---------</span><span class="w">              
</span><span class="nf">vmaas-466265.corpb.net</span><span class="w">                       </span><span class="nx">A</span><span class="w">      </span><span class="nx">0</span><span class="w">     </span><span class="nx">Answer</span><span class="w">     </span><span class="nx">92.242.132.24</span><span class="w">          
                                                                                              
                                                                                              
</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">Resolve-DnsName</span><span class="w"> </span><span class="nx">vmaas-466265.test.corpb.local</span><span class="w">                           
                                                                                              
</span><span class="nf">Name</span><span class="w">                                           </span><span class="nx">Type</span><span class="w">   </span><span class="nx">TTL</span><span class="w">   </span><span class="nx">Section</span><span class="w">    </span><span class="nx">IPAddress</span><span class="w">              
</span><span class="nf">----</span><span class="w">                                           </span><span class="nf">----</span><span class="w">   </span><span class="nf">---</span><span class="w">   </span><span class="nf">-------</span><span class="w">    </span><span class="nf">---------</span><span class="w">              
</span><span class="nf">vmaas-466265.test.corpb.local</span><span class="w">                </span><span class="nx">A</span><span class="w">      </span><span class="nx">1200</span><span class="w">  </span><span class="nx">Answer</span><span class="w">     </span><span class="nx">10.14.2.213</span><span class="w">            
                                                                                              
                                                                                              
</span><span class="err">&gt;</span><span class="w"> </span><span class="nf">Resolve-DnsName</span><span class="w"> </span><span class="nx">vmaas-466265</span><span class="w">                                              
                                                                                              
</span><span class="nf">Name</span><span class="w">                                           </span><span class="nx">Type</span><span class="w">   </span><span class="nx">TTL</span><span class="w">   </span><span class="nx">Section</span><span class="w">    </span><span class="nx">IPAddress</span><span class="w">              
</span><span class="nf">----</span><span class="w">                                           </span><span class="nf">----</span><span class="w">   </span><span class="nf">---</span><span class="w">   </span><span class="nf">-------</span><span class="w">    </span><span class="nf">---------</span><span class="w">              
</span><span class="nf">vmaas-466265.corpb.net</span><span class="w">                       </span><span class="nx">A</span><span class="w">      </span><span class="nx">0</span><span class="w">     </span><span class="nx">Answer</span><span class="w">     </span><span class="nx">92.242.132.24</span><span class="w">          
                                                                                              
</span><span class="c"># Note! The 92.242.132.24 are misleading responses. Use nslookup to check the domain.
</span><span class="w">
</span><span class="c"># It is barefruit.co.uk which VirginMedia uses to serve a page of search results as this is effectively
</span><span class="w">
</span><span class="c"># a DNS miss. Pretty annoying!</span></code></pre></figure> <p>A powershell command a bit like ping or traceroute is Test-NetConnection. Note quite a lot of networks don’t allow pings so traceroute can suffer from these black holes :-(</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="nf">Test-NetConnection</span><span class="w"> </span><span class="nx">vmaas-466265.test.corpb.local</span><span class="w">
</span><span class="err">&gt;</span><span class="nf">tracert.exe</span><span class="w"> </span><span class="s2">"vmaas-466265.test.corpb.local"</span></code></pre></figure> <p>Netstat is also a super useful command that will display what TCP/IP ports are active on your machine</p> <ul> <li>Invoke a single command</li> </ul> <p><code class="language-plaintext highlighter-rouge"> Invoke-Command -ComputerName COMPUTER -ScriptBlock { COMMAND } -credential USERNAME </code></p> <ul> <li>Enter a remote session</li> </ul> <p><code class="language-plaintext highlighter-rouge"> Enter-PSSession -ComputerName COMPUTER -Credential USER </code></p> <h3 id="create-a-transcript"> <a href="#create-a-transcript" aria-labelledby="create-a-transcript" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Create a transcript </h3> <p>You can create a transcript of everything that is typed and output to a powershell script using <code class="language-plaintext highlighter-rouge">Start-Transcript</code>. It outputs a timestamped file into your documents. Call <code class="language-plaintext highlighter-rouge">Stop-Transcript</code> to end.</p> <h3 id="convert-something-to-a-bool"> <a href="#convert-something-to-a-bool" aria-labelledby="convert-something-to-a-bool" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Convert something to a bool </h3> <p>The [boolean] placed in front of stuff does a good job of truthy conversion.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">_chocoInstalled</span><span class="p">(</span><span class="nv">$package</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="o">!</span><span class="p">[</span><span class="kt">boolean</span><span class="p">](</span><span class="nf">choco</span><span class="w"> </span><span class="nx">info</span><span class="w"> </span><span class="nv">$package</span><span class="w"> </span><span class="nt">--local-only</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Where</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"0 packages installed"</span><span class="p">})</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <h3 id="delayed-execution-lambdaanonomous-functions"> <a href="#delayed-execution-lambdaanonomous-functions" aria-labelledby="delayed-execution-lambdaanonomous-functions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Delayed execution, lambda/anonomous functions </h3> <p>The excellent {} syntax provides a way to have a callable bit of code that is later executed.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$vmaasInstallation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nf">Test-Path</span><span class="w"> </span><span class="s2">"C:\Program Files (x86)\Git\cmd\git.exe"</span><span class="p">}</span><span class="w">
</span><span class="o">&amp;</span><span class="w"> </span><span class="nv">$vmaasInstallation</span></code></pre></figure> <h3 id="function-decorators"> <a href="#function-decorators" aria-labelledby="function-decorators" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Function decorators </h3> <p>Basic syntax for writing a decorator</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">test</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">iwr</span><span class="w"> </span><span class="nx">google.com</span><span class="w"> </span><span class="p">}</span><span class="w">

</span><span class="nf">rename-item</span><span class="w"> </span><span class="nx">function:\test</span><span class="w"> </span><span class="nx">wrapped-test</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">test</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"wrapping test"</span><span class="p">;</span><span class="w"> </span><span class="nf">wrapped-test</span><span class="w"> </span><span class="p">}</span></code></pre></figure> <p>Writing a cache using a decorator that does some memoisation.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">get-url</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nf">iwr</span><span class="w"> </span><span class="nv">$url</span><span class="w"> </span><span class="p">}</span><span class="w">

</span><span class="nf">rename-item</span><span class="w"> </span><span class="nx">function:\get-url</span><span class="w"> </span><span class="nx">wrapped-get-url</span><span class="w">

</span><span class="bp">$_</span><span class="nf">RESULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{}</span><span class="w">

</span><span class="kr">function</span><span class="w"> </span><span class="nf">get-url</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="bp">$_</span><span class="nf">RESULT</span><span class="p">[</span><span class="nv">$url</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"</span><span class="nv">$url</span><span class="s2"> not in cache"</span><span class="w">
    </span><span class="bp">$_</span><span class="nf">RESULT</span><span class="p">[</span><span class="nv">$url</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">wrapped-get-url</span><span class="w"> </span><span class="nt">-url</span><span class="w"> </span><span class="nv">$url</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"</span><span class="nv">$url</span><span class="s2"> in cache"</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="bp">$_</span><span class="nf">RESULT</span><span class="p">[</span><span class="nv">$url</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>I had originally wanted “Does powershell have a memoisation decorator type function like python’s <a href="https://docs.python.org/3/library/functools.html#functools.lru_cache">lru_cache</a>? I have IO bound file query thing that would be nice to use something like lru_cache for. Otherwise, I’m going to use a global dictionary”</p> <h3 id="reimporting-a-module"> <a href="#reimporting-a-module" aria-labelledby="reimporting-a-module" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reimporting a module </h3> <p>Debugging a module you’ll often have to reload it. Use -force</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">Import-Module</span><span class="w"> </span><span class="nx">tooDebug.ps1</span><span class="w">
</span><span class="c"># do debuging, edit file, save and wish to reload it
</span><span class="w">
</span><span class="nf">Import-Module</span><span class="w"> </span><span class="nx">tooDebug.ps1</span><span class="w"> </span><span class="nt">-force</span></code></pre></figure> <h3 id="find-current-file-locations"> <a href="#find-current-file-locations" aria-labelledby="find-current-file-locations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Find current file location’s </h3> <p>In general, a stack overflow suggested inspecting the help about automatic variables:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">get-help</span><span class="w"> </span><span class="nx">about_Automatic_Variables</span><span class="w"> </span><span class="nt">-full</span></code></pre></figure> <p>However, to answer the question, Powershell equivalent of python’s <strong>file</strong> is:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="bp">$_</span><span class="nf">_file__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">$MyInvocation</span><span class="o">.</span><span class="nf">MyCommand</span><span class="o">.</span><span class="nf">Definition</span><span class="w">
</span><span class="c"># Can get the directory like
</span><span class="w">
</span><span class="bp">$_</span><span class="nf">_dir__</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Split-Path</span><span class="w"> </span><span class="bp">$_</span><span class="nx">_file__</span></code></pre></figure> <p>Though the name I’ve given it, with double-duners makes me wonder whether powershell enforces public/private names with underscores?</p> <h3 id="scopes"> <a href="#scopes" aria-labelledby="scopes" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scopes </h3><pre><code class="language-BASH">@'
&gt;&gt; function lfunc { $x = 100; $script:x = 10; "lfunc: x = $x"}
&gt;&gt; lfunc
&gt;&gt; "my-script:x = $x"
&gt;&gt; "global:x = ${global:x}"
&gt;&gt; '@ &gt; myscript.ps1
</code></pre><p>There’s a global scope that can be accessed using “$global:” the colon is important. Then there is a script scope in scripts “$script:”.</p> <h3 id="try-to-return-last-exit-code-only-from-a-function"> <a href="#try-to-return-last-exit-code-only-from-a-function" aria-labelledby="try-to-return-last-exit-code-only-from-a-function" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Try to return last-exit code only from a function </h3> <p>In python, when we return something from a function, we need to be explicit and use ‘return’ otherwise the function will return None.</p> <p>However, in powershell, it implicitly returns things from the function. This is because powershell is a shell, it doesn’t return results - it writes output or emits objects. This makes some difference!</p> <p>For example, this code is trying to determine whether the linter passed or failed</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">Lint-Bem</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="p">[</span><span class="kt">CmdletBinding</span><span class="p">()]</span><span class="w">
    </span><span class="kr">Param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="kt">Parameter</span><span class="p">(</span><span class="kt">Mandatory</span><span class="o">=</span><span class="nv">$True</span><span class="p">,</span><span class="w"> </span><span class="kt">HelpMessage</span><span class="o">=</span><span class="s2">"Select a Linter"</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="kt">ValidateSet</span><span class="p">(</span><span class="s1">'pylint'</span><span class="p">,</span><span class="w"> </span><span class="s1">'flake8'</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nv">$Linter</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="c"># Note Linter directly maps to the name of the test within selftests
</span><span class="w">
    </span><span class="c"># but cannot add .py to the end, otherwise test-discovery fails.
</span><span class="w">
    </span><span class="nf">python</span><span class="w"> </span><span class="bp">$_</span><span class="nx">run_script</span><span class="w"> </span><span class="s2">"py.selftests.test_</span><span class="nv">$Linter</span><span class="s2">"</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="bp">$LastExitCode</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"last-exit code is </span><span class="bp">$LastExitCode</span><span class="s2">"</span><span class="w">
        </span><span class="kr">return</span><span class="w"> </span><span class="nv">$True</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"last-exit code is </span><span class="bp">$LastExitCode</span><span class="s2">"</span><span class="w">
        </span><span class="kr">return</span><span class="w"> </span><span class="nv">$False</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="kr">function</span><span class="w"> </span><span class="nf">Lint-Interactive</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nv">$Linter</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="nv">$resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Read-Host</span><span class="w"> </span><span class="s2">"Run </span><span class="nv">${Linter}</span><span class="s2">? Y/N"</span><span class="w">  </span><span class="c"># User may want to skip a linter
</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$resp</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"y"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Lint-Bem</span><span class="w"> </span><span class="nv">$Linter</span><span class="w">
        
        </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="nv">$result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c"># It the linting fails
</span><span class="w">
            </span><span class="nv">$resp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">Read-Host</span><span class="w"> </span><span class="s2">"</span><span class="nv">$Linter</span><span class="s2"> linting failed. Ignore? Y/N"</span><span class="w">
            </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$resp</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"n"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c"># User cares that the linter has failed, exit 1
</span><span class="w">
                </span><span class="nf">Write-host</span><span class="w"> </span><span class="s2">"Stopping linting. Exit 1"</span><span class="w">
                </span><span class="kr">exit</span><span class="w"> </span><span class="mi">1</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="c"># else use is ignoring faiure and continuing
</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nf">write-host</span><span class="w"> </span><span class="s2">"result is </span><span class="nv">$result</span><span class="s2">"</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="c"># else linter passed
</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="c"># else user is skipping this linter
</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>The problem is that even if the $LastExitCode in Lint-Bem is not zero, the ‘if (-not $result)’ does not resolve to True and so the user is never asked whether the want to ignore the failed result. Ahh!</p> <p>It’s because the $result is actually filled with all the objects written to the output and not use a boolean. Ahh!</p> <p>It looks like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>last-exit code is 1
result is C:\dev\repo\tests\py\log.py:7:1: E302 expected 2 blank lines, found 1  C:\dev\repo\tests\py\log.py:38:43: F823 local variable 'proc' (defined in enclosing scope on line 19) referenced before assignment  C:\dev\repo\tests\py\log.py:58:16: F821 undefined name 'connect'  C:\dev\repo\tests\py\log.py:59:27: F821 undefined name 'connect'   2019-04-16 12:00:30,256 ERROR [plugins:addFailure:59] Test failure for py.selftests.test_flake8.Flake8Tests.test_flake8 2019-04-16 12:00:30,266 INFO [run:main:138] Exiting with True False
</code></pre></div></div> <h3 id="returning-things-from-functions"> <a href="#returning-things-from-functions" aria-labelledby="returning-things-from-functions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Returning things from functions </h3> <p>Perhaps you want to return a custom object. That’s very useful. Let’s say we have matched upon a URL, and extract some useful information about the object.</p> <p>Like in python, we can return a tuple of stuff. But that’s not as useful as returning a nicely structured object.</p> <p>For example,</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="cm">&lt;#
    </span><span class="cs">.SYNOPSIS</span><span class="cm">
    Useful for providing a jenkins URL and getting back useful information extracted from
    the URL. Meant as a helper function.
#&gt;</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">Match-JenkinsJobUrl</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Param</span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="kt">Parameter</span><span class="p">(</span><span class="kt">HelpMessage</span><span class="o">=</span><span class="s2">"Jenkins URL to extract a job and number from. Does not currently handle urls without a jobname and build number in them."</span><span class="p">,</span><span class="w">
                   </span><span class="kt">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="w">
        </span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="w">
        </span><span class="nv">$Url</span><span class="w">
    </span><span class="p">)</span><span class="w">
    </span><span class="c"># expecting URl to be something like https://jenkins.uk.corpb.net/job/cam_Component_Tests_On_Vmaas/3097/console
</span><span class="w">
    </span><span class="c"># or perhaps https://jenkins.uk.corpb.net/job/cam_Component_Tests_On_Vmaas/3097/
</span><span class="w">
    </span><span class="nv">$Url</span><span class="w"> </span><span class="o">-match</span><span class="w"> </span><span class="s2">"(.*corpb\.net\/)job\/(\w+)\/(\d*)"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">out-null</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$matches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nv">$hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">
        </span><span class="nv">$Jobname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$matches</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">
        </span><span class="nv">$BuildNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$matches</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w">

        </span><span class="kr">return</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">PSObject</span><span class="w"> </span><span class="nt">-Property</span><span class="w"> </span><span class="p">@{</span><span class="w">
            </span><span class="nx">Url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Url</span><span class="w">
            </span><span class="nx">Hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$hostname</span><span class="w">
            </span><span class="nx">Job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Jobname</span><span class="w">
            </span><span class="nx">JobUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">${hostname}</span><span class="s2">job/</span><span class="nv">${Jobname}</span><span class="s2">"</span><span class="w">
            </span><span class="nx">Build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$BuildNumber</span><span class="w">
            </span><span class="nx">BuildUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$matches</span><span class="err">[</span><span class="nx">0</span><span class="err">]</span><span class="w">
        </span><span class="p">}</span><span class="w">

    </span><span class="p">}</span><span class="w">
    </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c"># don't actually prnt the url, use escape of $ variable expansion with ''
</span><span class="w">
        </span><span class="kr">throw</span><span class="w"> </span><span class="s1">'$url does not match regex.'</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>The useful command here is the ++New-Object++ command.</p> <h2 id="the-ast"> <a href="#the-ast" aria-labelledby="the-ast" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The AST </h2> <p>Powershell really opens the interpreter to you. The AST is available to you. Letting you do meta programming stuff.</p> <p>For example, the peskiness of erroaction means you need to check whether a command may at some point use ‘throw’ because other -erroraction is insufficent to continue if there’s an error. Lets write a function that at least checks whether any commands written in posh contain a throw. Lets look at the AST</p> <div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">filter</span><span class="w"> </span><span class="nf">test-throws</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">-not</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">scriptblock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nf">write-warning</span><span class="w"> </span><span class="s2">"no script found for </span><span class="bp">$_</span><span class="s2">"</span><span class="w">
        </span><span class="kr">return</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="kr">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="p">[</span><span class="kt">bool</span><span class="p">]</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Scriptblock</span><span class="o">.</span><span class="nf">ast</span><span class="o">.</span><span class="nf">findall</span><span class="p">({</span><span class="bp">$args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-is</span><span class="w"> </span><span class="p">[</span><span class="no">System.Management.Automation.Language.</span><span class="kt">ThrowStatementAst</span><span class="p">]},</span><span class="w"> </span><span class="bp">$true</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <h2 id="posh-things-that-suck"> <a href="#posh-things-that-suck" aria-labelledby="posh-things-that-suck" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> POSH things that suck </h2> <p>The requirement for some things where one uses ‘-confirm -force’ and it still asks for user input, e.g. (Though I believe this a faulty implementation by those who made this commandlet.)</p> <p>I believe the fix here is to run powershell in NonIteractive mode! E.g. see https://serverfault.com/a/642848</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="kr">function</span><span class="w"> </span><span class="nf">SetUSUKKeyboard</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nf">Write-Verbose</span><span class="w"> </span><span class="s2">"Setting uk and us keyboard"</span><span class="w">
    </span><span class="c"># set call here doesn't care, always stop and waits for user input
</span><span class="w">
    </span><span class="nf">set-winuserlanguagelist</span><span class="w"> </span><span class="nx">en-GB</span><span class="p">,</span><span class="w"> </span><span class="nx">en-US</span><span class="w"> </span><span class="nt">-Confirm</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>NO! The posh above is wrong, this works</p> <div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">    </span><span class="nf">set-winuserlanguagelist</span><span class="w"> </span><span class="nx">en-GB</span><span class="p">,</span><span class="w"> </span><span class="nx">en-US</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
</span></code></pre></div></div> <p>The -confirm is actually to ask the user to confirm…. Ruby would have named the parameter Confirm?</p> <p>Does not have any context-manager equivalent to ‘with’ that python has! As far as I can tell. I think you are required to rely upon try and catch. A common example, a script can only be run from a particular directory. Need to write cd to the directory and if script errors, switch back out of the directory in the catch. Or something like that.</p> <h3 id="namespaces"> <a href="#namespaces" aria-labelledby="namespaces" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Namespaces </h3> <p>In powershell, if you want to get access to some .net class, you can use the full name like this:</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c"># For windows form, we first need the load the assembly
</span><span class="w">
</span><span class="kr">using</span><span class="w"> </span><span class="kr">assembly</span><span class="w"> </span><span class="nf">System.Windows.Forms</span><span class="w">
</span><span class="c"># The [] is the type operator, it says we are specifying the class/type name
</span><span class="w">
</span><span class="c"># This specifies the windows form type
</span><span class="w">
</span><span class="p">[</span><span class="no">System.Windows.Forms.</span><span class="kt">Form</span><span class="p">]</span><span class="w">
</span><span class="c"># But this is obviously quite long to write, so we can load in the namespace which
</span><span class="w">
</span><span class="c"># means we can use [Form] the class
</span><span class="w">
</span><span class="kr">using</span><span class="w"> </span><span class="kr">namespace</span><span class="w"> </span><span class="nf">System.Windows.Forms</span><span class="w">

</span><span class="nv">$form</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Form</span><span class="p">]</span><span class="w"> </span><span class="p">@{</span><span class="w">
 </span><span class="nx">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'My First Form'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Button</span><span class="p">]</span><span class="w"> </span><span class="p">@{</span><span class="w">
 </span><span class="nx">Text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Push Me!'</span><span class="w">
 </span><span class="nx">Dock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'Fill'</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$button</span><span class="o">.</span><span class="nf">add_Click</span><span class="p">{</span><span class="w">
 </span><span class="nv">$form</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="nv">$form</span><span class="o">.</span><span class="nf">Controls</span><span class="o">.</span><span class="nf">Add</span><span class="p">(</span><span class="nv">$button</span><span class="p">)</span><span class="w">
</span><span class="nv">$form</span><span class="o">.</span><span class="nf">ShowDialog</span><span class="p">()</span></code></pre></figure> <p>However, the namespace syntax is just like pythons <code class="language-plaintext highlighter-rouge">from Forms import *</code>. Ahh! How can one know that the [Form] is from System..Windows.Forms rather than some other library? You can’t…</p> <p>The <code class="language-plaintext highlighter-rouge">using namespace &lt;name&gt;</code> means load in a .NET class. Whereas, if you want to load in a powershell module you would write <code class="language-plaintext highlighter-rouge">using module &lt;name&gt;</code>.</p> <p>I assume the <code class="language-plaintext highlighter-rouge">using assembly &lt;name&gt;</code> means something like load in a dll?</p> <p>Extract from Powershell in Action about using assembly,</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"""Here are a couple of important points to remember about the using statement. First,
it has to be the first non-comment statement in a script or module. This is because,
with using, types are resolved at compile time instead of runtime. This is a good thing
because it helps you catch your errors sooner. Second, you have to have the assembly containing the reference type namespace loaded before you can run your script.
Because a lot of things are loaded by PowerShell by default this isn’t that much of a
problem. This is what using assembly &lt;...&gt; is intended for. By specifying both statements as shown in the example, everything will work fine."""
</code></pre></div></div> <h3 id="out-string-tricky-strings"> <a href="#out-string-tricky-strings" aria-labelledby="out-string-tricky-strings" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Out-string, tricky strings! </h3> <p>Ah it’s easy to get tricked with powershell’s automatic conversion of objects to strings. I had the contents of a file from <code class="language-plaintext highlighter-rouge">$lines = Get-Content file.log</code>, when I tried to put it into a string “$lines”, all the newlines were gone. Whoops. Took me a while to find out I needed to use Out-String.</p> <p>From ExpertT: <em>“what you’re seeing is the inbuilt default “Out-Default” function draining remaining objects in the pipeline and rendering them in the ‘default’ way (which is amazingly rich and complex as it happens) but the one truth about powershell is what looks like a string very likely isn’t”</em></p> <h3 id="conver-between-user-names-and-ssids"> <a href="#conver-between-user-names-and-ssids" aria-labelledby="conver-between-user-names-and-ssids" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conver between user names and ssids </h3> <p>Coming from <a href="https://community.spiceworks.com/how_to/2776-powershell-sid-to-user-and-user-to-sid">https://community.spiceworks.com/how_to/2776-powershell-sid-to-user-and-user-to-sid</a></p> <p>This will give you a Domain User’s SID</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$objUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">System.Security.Principal.NTAccount</span><span class="p">(</span><span class="s2">"DOMAIN_NAME"</span><span class="p">,</span><span class="w"> </span><span class="s2">"USER_NAME"</span><span class="p">)</span><span class="w">
</span><span class="nv">$strSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$objUser</span><span class="o">.</span><span class="nf">Translate</span><span class="p">([</span><span class="no">System.Security.Principal.</span><span class="kt">SecurityIdentifier</span><span class="p">])</span><span class="w">
</span><span class="nv">$strSID</span><span class="o">.</span><span class="nf">Value</span></code></pre></figure> <p>This will allow you to enter a SID and find the Domain User</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$objSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">System.Security.Principal.SecurityIdentifier</span><span class="w"> </span><span class="se">`
</span><span class="w">
</span><span class="p">(</span><span class="s2">"ENTER-SID-HERE"</span><span class="p">)</span><span class="w">
</span><span class="nv">$objUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$objSID</span><span class="o">.</span><span class="nf">Translate</span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="no">System.Security.Principal.</span><span class="kt">NTAccount</span><span class="p">])</span><span class="w">
</span><span class="nv">$objUser</span><span class="o">.</span><span class="nf">Value</span></code></pre></figure> <p>Convert from local user to sid.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$objUser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">New-Object</span><span class="w"> </span><span class="nx">System.Security.Principal.NTAccount</span><span class="p">(</span><span class="s2">"LOCAL_USER_NAME"</span><span class="p">)</span><span class="w">
</span><span class="nv">$strSID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$objUser</span><span class="o">.</span><span class="nf">Translate</span><span class="p">([</span><span class="no">System.Security.Principal.</span><span class="kt">SecurityIdentifier</span><span class="p">])</span><span class="w">
</span><span class="nv">$strSID</span><span class="o">.</span><span class="nf">Value</span></code></pre></figure> <h3 id="certicates"> <a href="#certicates" aria-labelledby="certicates" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Certicates </h3> <p>Powershell provides access to the certstore. That’s where the machines certificates are kept</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="err">&gt;</span><span class="w"> </span><span class="nf">ls</span><span class="w"> </span><span class="nx">Cert:</span><span class="w">
                                                                                 
</span><span class="nf">Location</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">CurrentUser</span><span class="w">                                                         
</span><span class="nf">StoreNames</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nf">TrustedPublisher</span><span class="p">,</span><span class="w"> </span><span class="nx">ClientAuthIssuer</span><span class="p">,</span><span class="w"> </span><span class="nx">Root</span><span class="p">,</span><span class="w"> </span><span class="nx">UserDS...</span><span class="p">}</span><span class="w">               
                                                                                 
</span><span class="nf">Location</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">LocalMachine</span><span class="w">                                                        
</span><span class="nf">StoreNames</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nf">TestSignRoot</span><span class="p">,</span><span class="w"> </span><span class="nx">ClientAuthIssuer</span><span class="p">,</span><span class="w"> </span><span class="nx">Remote</span><span class="w"> </span><span class="nx">Desktop</span><span class="p">,</span><span class="w"> </span><span class="nx">Root...</span><span class="p">}</span><span class="w">           
                                                                                 
                                                                                 
                                                                                 </span></code></pre></figure> <h3 id="conflicting-powershell-commands"> <a href="#conflicting-powershell-commands" aria-labelledby="conflicting-powershell-commands" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Conflicting powershell commands </h3> <p>Powershell doesn’t prevent you importing or overwriting commands with the same name. For instance, the s0s shell defines it’s own Compare-Object command.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">C:\Users\donal.mee</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">get-command</span><span class="w"> </span><span class="nx">compare-object</span><span class="w">                                                                          
                                                                                                                        
</span><span class="nf">CommandType</span><span class="w">     </span><span class="nx">Name</span><span class="w">                                               </span><span class="nx">Version</span><span class="w">    </span><span class="nx">Source</span><span class="w">                                    
</span><span class="nf">-----------</span><span class="w">     </span><span class="nf">----</span><span class="w">                                               </span><span class="nf">-------</span><span class="w">    </span><span class="nf">------</span><span class="w">                                    
</span><span class="kr">Function</span><span class="w">        </span><span class="nf">Compare-Object</span><span class="w">                                     </span><span class="mf">0.0.2</span><span class="w">      </span><span class="nf">s0s</span><span class="w">                                       
                                                                                                                        
                                                                                                                        
</span><span class="nf">C:\Users\donal.mee</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">get-command</span><span class="w"> </span><span class="nt">-name</span><span class="w"> </span><span class="o">*</span><span class="nx">compare-object</span><span class="o">*</span><span class="w">                                                                  
                                                                                                                        
</span><span class="nf">CommandType</span><span class="w">     </span><span class="nx">Name</span><span class="w">                                               </span><span class="nx">Version</span><span class="w">    </span><span class="nx">Source</span><span class="w">                                    
</span><span class="nf">-----------</span><span class="w">     </span><span class="nf">----</span><span class="w">                                               </span><span class="nf">-------</span><span class="w">    </span><span class="nf">------</span><span class="w">                                    
</span><span class="kr">Function</span><span class="w">        </span><span class="nf">Compare-Object</span><span class="w">                                     </span><span class="mf">0.0.2</span><span class="w">      </span><span class="nf">s0s</span><span class="w">                                       
</span><span class="nf">Cmdlet</span><span class="w">          </span><span class="nx">Compare-Object</span><span class="w">                                     </span><span class="nx">3.1.0.0</span><span class="w">    </span><span class="nx">Microsoft.PowerShell.Utility</span><span class="w">              
                                                                                                                        
                                                                                                                        </span></code></pre></figure> <p>One way to select the want you want is to remove the offending module</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">remove-module</span><span class="w"> </span><span class="nx">s0s</span></code></pre></figure> <p>But, you can also provide the module name before invoking the command, to be more specific. The source seems to be where to select this.</p> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">microsoft.powershell.utility\Compare-Object</span></code></pre></figure> <figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nf">s0s\Compare-Object</span></code></pre></figure> <h3 id="comparing-nested-objects"> <a href="#comparing-nested-objects" aria-labelledby="comparing-nested-objects" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Comparing nested objects </h3> <p>There is an in-built compare-object, but try to compare two hashes. Even if their contents are the different or the same the compare-object is useless. It cannot compare nested objects or really objects of much complexity.</p> <p>You need to select the properties that you want to compare it with. ExpertT’s shell has an enhanced compare object and compare dictionary function. The inbuilt one is pretty crap.</p> <h3 id="write-host-host-console-wtf"> <a href="#write-host-host-console-wtf" aria-labelledby="write-host-host-console-wtf" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Write-host host console wtf? </h3> <p>It’s actually hard to capture all the output of the powershell console. It has the idea of streams but a lot of stuff doesn’t write to the streams. This is the problem with write-host. It writes directly to the host program, skips the streams so the user can see it but the console buffers don’t see if. Thus you can’t actually capture the output to a text file. This sucks!</p> <div class="language-posh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">powershell.exe</span><span class="w"> </span><span class="o">*</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">posh.log</span><span class="w"> </span><span class="nt">-command</span><span class="w"> </span><span class="err">&lt;</span><span class="nx">script</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">writes</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">host</span><span class="w"> </span><span class="nx">directly</span><span class="err">&gt;</span><span class="w">
</span><span class="c"># However, the posh.log will only contain output to the host, like the stuff from set-psdebug -trace 1 but it will not contain</span><span class="w">
</span><span class="c"># the input commands, so all you have is output which is half the puzzle...</span><span class="w">
</span></code></pre></div></div> <p>And even more annoying, lets say you want to trace the execution of a program with set-psdebug -trace 1 and redirect that output to a file. Nope, no luck. It writes directly to the host, not the console. So you effectively can’t capture it.</p> <h3 id="verbose-perference"> <a href="#verbose-perference" aria-labelledby="verbose-perference" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Verbose perference </h3> <p>It doesn’t seem to work. Its not a global thing if it’s set in a script. So your subsequent calls don’t see the verbose preference being set. You probably have to set it as a global preference or something.</p> <h3 id="classes"> <a href="#classes" aria-labelledby="classes" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Classes </h3> <p>POSH classes suck. They are available but can only be loaded as dotnet runtime classes and so you can’t actually load them through the import-module stuff. It’s actually bound once into the runtime and can’t re unloaded, unless there’s some dotnet tricks that will let you do it.</p> <p>POSH seems to expect everyone to use dynamic method/attribute addition methods to build ‘objects’. But it’s sucky objects in my opinion.</p> <h3 id="catching-errors-with--erroraction"> <a href="#catching-errors-with--erroraction" aria-labelledby="catching-errors-with--erroraction" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Catching errors with -erroraction </h3> <p>Actually, you’d think erroraction is respected. It’s not… There’s some commentary above.</p> <p>But basically you can’t know ahead of time whether something is going to use ‘throw’ and so whether you need to wrap it in a try/catch. You basically have to write a parser… see the abstract. Note, how to write a parser for dotnet code is more tricky I suspect.</p> </div> </div> <div class="search-overlay"></div> </div> <script> const toggleDarkMode = document.querySelector('.js-toggle-dark-mode'); jtd.addEvent(toggleDarkMode, 'click', function(){ if (jtd.getTheme() === 'dark') { jtd.setTheme('light'); toggleDarkMode.textContent = 'Dark mode'; } else { jtd.setTheme('dark'); toggleDarkMode.textContent = 'Light mode'; } }); </script> </body> </html>
